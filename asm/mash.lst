     1                                  ; mash
     2                                  ; TAB=4
     3                                  
     4                                  ; memo
     5                                  ; 実機で動かす場合相手側のシリアルポートと接続しないと動作がとても遅くなるので注意！
     6                                  
     7                                  ; ロゴ
     8                                  ; https://jp.mathworks.com/matlabcentral/fileexchange/181715-makebanner-big-ascii-style-comment-generator
     9                                  
    10                                  ; --- ファイルインクルード ---
    11                                  %include        "../asm/define.asm"
     1                              <1> ; --- 一般定義 ---
     2                              <1> %define     _NULL               0x0000
     3                              <1> 
     4                              <1> ; --- 画面関連 ---
     5                              <1> %define     DISP_COLSIZE        79
     6                              <1> %define     DISP_LINESIZE       24
     7                              <1> 
     8                              <1> ; --- ディレクトリ構造 ---
     9                              <1> ; root
    10                              <1> %define     DIR_ROOT            0x0015
    11                              <1> 
    12                              <1> ; root一覧
    13                              <1> %define     DIR_BIN             0x0016
    14                              <1> %define     DIR_USR             0x0017
    15                              <1> %define     DIR_README          0x0018
    16                              <1> 
    17                              <1> ; bin一覧
    18                              <1> %define     DIR_TEST            0x0019
    19                              <1> 
    20                              <1> ; --- ディレクトセクタ ---
    21                              <1> ; アトリビュート
    22                              <1> %define     ATR_EMPTY           0x00
    23                              <1> %define     ATR_DIR             0x01
    24                              <1> %define     ATR_FILE            0x02
    25                              <1> 
    26                              <1> ; --- 入出力 ---
    27                              <1> ; ファイルディスクリプタ
    28                              <1> %define     FD_KEYBORD          0x00
    29                              <1> %define     FD_DISPLAY          0x01
    30                              <1> %define     FD_SERIAL           0x02
    31                              <1> %define     FD_FILE0            0x03
    32                              <1> %define     FD_FILE1            0x04
    33                              <1> %define     FD_FILE2            0x05
    34                              <1> %define     FD_FILE3            0x06
    35                              <1> 
    36                              <1> ; --- シェル変数 ---
    37                              <1> ; 変数型
    38                              <1> %define     TYPE_UINT           0x00
    39                              <1> %define     TYPE_SINT           0x01
    40                              <1> %define     TYPE_CHAR           0x02
    41                              <1> %define     TYPE_ARR            0x10
    42                              <1> %define     TYPE_STR            0x12
    43                              <1> 
    44                              <1> ; --- エラーコード ---
    45                              <1> %define     RET_OK              0x00
    46                              <1> %define     RET_NG_PRM          0x01    ; パラメータエラー
    47                              <1> 
    48                              <1> ; --- マクロ ---
    49                              <1> ; memcpy
    50                              <1> ; %1 dest(コピー先アドレス)
    51                              <1> ; %2 src(コピー元アドレス)
    52                              <1> ; %3 size(コピーサイズ)
    53                              <1> %macro MACRO_MEMCPY 3
    54                              <1>         PUSH    DI
    55                              <1>         PUSH    SI
    56                              <1>         PUSH    CX
    57                              <1> 
    58                              <1>         MOV     DI, %1
    59                              <1>         MOV     SI, %2
    60                              <1>         MOV     CX, %3
    61                              <1> 
    62                              <1>         CALL    libMemcpy
    63                              <1> 
    64                              <1>         POP     CX
    65                              <1>         POP     SI
    66                              <1>         POP     DI
    67                              <1> %endmacro
    68                              <1> 
    69                              <1> ; strchr
    70                              <1> ; %1 str(検索する先頭アドレス)
    71                              <1> ; %2 c(検索する文字)
    72                              <1> ; %3 ret(発見したアドレス)
    73                              <1> %macro MACRO_STRCHR 2
    74                              <1>         PUSH    SI
    75                              <1>         PUSH    AX
    76                              <1> 
    77                              <1>         MOV     SI, %1
    78                              <1>         MOV     AX, %2
    79                              <1> 
    80                              <1>         CALL    libStrchr
    81                              <1> 
    82                              <1>         POP     AX
    83                              <1>         POP     SI
    84                              <1> %endmacro
    85                              <1> 
    86                              <1> ; strchr(c89)相当
    87                              <1> ; in  : SI      探索する文字列
    88                              <1> ;       AH      区切り文字
    89                              <1> ; out : DI      null: 区切り文字は存在しない
    90                              <1> ;               null以外: 最初に発見したアドレス
    91                              <1> 
    92                              <1> ; シリアル初期化
    93                              <1> %macro MACRO_SERIAL_INIT 0
    94                              <1>         MOV     AH, 0x00                ; シリアルポート設定
    95                              <1>         MOV     AL, 0xe3                ; 0bBBBPPSCC, 9600bps, None, 1bit, 8bit
    96                              <1>         MOV     DX, 0x0000              ; 0ch = COM1, xch = COMx+1
    97                              <1>         INT     0x14
    98                              <1> %endmacro
    99                              <1> 
   100                              <1> ; シリアル1文字出力
   101                              <1> %macro MACRO_SERIAL_PUTC 1
   102                              <1>         PUSH    AX
   103                              <1>         MOV     AL, %1
   104                              <1>         CALL    dbgSingle
   105                              <1>         POP     AX
   106                              <1> %endmacro
   107                              <1> 
   108                              <1> ; メモリダンプマクロ
   109                              <1> ; %1 ダンプするバイト数
   110                              <1> ; %2 ダンプする先頭アドレス
   111                              <1> %macro DEBUG_REGISTER_DUMP 2
   112                              <1>         PUSH    AX
   113                              <1>         PUSH    DI
   114                              <1> 
   115                              <1>         MOV     AX, %1
   116                              <1>         MOV     DI, %2
   117                              <1>         CALL    dbgDump
   118                              <1> 
   119                              <1>         POP     DI
   120                              <1>         POP     AX
   121                              <1> %endmacro
    12                                  %define         __DEBUG                 ; デバッグ時に有効
    13                                  
    14                                          ORG     0x4000
    15 00000000 E9F301                          JMP     mashInit
    16                                  
    17                                  ; //////////////////////////////////////////////////////////////////////////// ;
    18                                  ; --- 定数 ---
    19                                  ;  ██████╗ ██████╗ ███╗  ██╗ ██████╗████████╗
    20                                  ; ██╔════╝██╔═══██╗████╗ ██║██╔════╝╚══██╔══╝
    21                                  ; ██║     ██║   ██║██╔██╗██║╚█████╗    ██║   
    22                                  ; ██║     ██║   ██║██║╚████║ ╚═══██╗   ██║   
    23                                  ; ╚██████╗╚██████╔╝██║ ╚███║██████╔╝   ██║   
    24                                  ;  ╚═════╝ ╚═════╝ ╚═╝  ╚══╝╚═════╝    ╚═╝   
    25                                  ; //////////////////////////////////////////////////////////////////////////// ;
    26                                  cMashLogo:                              ; ロゴ(35x6 = 210byte)
    27                                          ;       ███╗   ███╗                                                        █████╗                                          ██████╗                                        ██╗  ██╗
    28                                          ;       ████╗ ████║                                                       ██╔══██╗                                        ██╔════╝                                        ██║  ██║
    29                                          ;       ██╔████╔██║                                                       ██║  ██║                                        ╚█████╗                                         ███████║
    30                                          ;       ██║╚██╔╝██║                                                       ███████║                                         ╚═══██╗                                        ██╔══██║
    31                                          ;       ██║ ╚═╝ ██║                                                       ██╔══██║                                        ██████╔╝                                        ██║  ██║
    32                                          ;       ╚═╝     ╚═╝                                                       ╚═╝  ╚═╝                                        ╚═════╝                                         ╚═╝  ╚═╝
    33                                          ;       M                                                                 A                                               S                                               H                                             
    34 00000003 DBDBDBBB202020DBDB-             DB      0xdb, 0xdb, 0xdb, 0xbb, 0x20, 0x20, 0x20, 0xdb, 0xdb, 0xdb, 0xbb, 0x20, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xbb, 0x20, 0x20, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xbb, 0xdb, 0xdb, 0xbb, 0x20, 0x20, 0xdb, 0xdb, 0xbb
    34 0000000C DBBB20DBDBDBDBDBBB-
    34 00000015 2020DBDBDBDBDBDBBB-
    34 0000001E DBDBBB2020DBDBBB   
    35 00000026 DBDBDBDBBB20DBDBDB-             DB      0xdb, 0xdb, 0xdb, 0xdb, 0xbb, 0x20, 0xdb, 0xdb, 0xdb, 0xdb, 0xba, 0xdb, 0xdb, 0xc9, 0xcd, 0xcd, 0xdb, 0xdb, 0xbb, 0xdb, 0xdb, 0xc9, 0xcd, 0xcd, 0xcd, 0xcd, 0xbc, 0xdb, 0xdb, 0xba, 0x20, 0x20, 0xdb, 0xdb, 0xba
    35 0000002F DBBADBDBC9CDCDDBDB-
    35 00000038 BBDBDBC9CDCDCDCDBC-
    35 00000041 DBDBBA2020DBDBBA   
    36 00000049 DBDBC9DBDBDBDBC9DB-             DB      0xdb, 0xdb, 0xc9, 0xdb, 0xdb, 0xdb, 0xdb, 0xc9, 0xdb, 0xdb, 0xba, 0xdb, 0xdb, 0xba, 0x20, 0x20, 0xdb, 0xdb, 0xba, 0xc8, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xbb, 0x20, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xba
    36 00000052 DBBADBDBBA2020DBDB-
    36 0000005B BAC8DBDBDBDBDBBB20-
    36 00000064 DBDBDBDBDBDBDBBA   
    37 0000006C DBDBBAC8DBDBC9BCDB-             DB      0xdb, 0xdb, 0xba, 0xc8, 0xdb, 0xdb, 0xc9, 0xbc, 0xdb, 0xdb, 0xba, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xba, 0x20, 0xc8, 0xcd, 0xcd, 0xcd, 0xdb, 0xdb, 0xbb, 0xdb, 0xdb, 0xc9, 0xcd, 0xcd, 0xdb, 0xdb, 0xba
    37 00000075 DBBADBDBDBDBDBDBDB-
    37 0000007E BA20C8CDCDCDDBDBBB-
    37 00000087 DBDBC9CDCDDBDBBA   
    38 0000008F DBDBBA20C8CDBC20DB-             DB      0xdb, 0xdb, 0xba, 0x20, 0xc8, 0xcd, 0xbc, 0x20, 0xdb, 0xdb, 0xba, 0xdb, 0xdb, 0xc9, 0xcd, 0xcd, 0xdb, 0xdb, 0xba, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xdb, 0xc9, 0xbc, 0xdb, 0xdb, 0xba, 0x20, 0x20, 0xdb, 0xdb, 0xba
    38 00000098 DBBADBDBC9CDCDDBDB-
    38 000000A1 BADBDBDBDBDBDBC9BC-
    38 000000AA DBDBBA2020DBDBBA   
    39 000000B2 C8CDBC2020202020C8-             DB      0xc8, 0xcd, 0xbc, 0x20, 0x20, 0x20, 0x20, 0x20, 0xc8, 0xcd, 0xbc, 0xc8, 0xcd, 0xbc, 0x20, 0x20, 0xc8, 0xcd, 0xbc, 0xc8, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xbc, 0x20, 0xc8, 0xcd, 0xbc, 0x20, 0x20, 0xc8, 0xcd, 0xbc
    39 000000BB CDBCC8CDBC2020C8CD-
    39 000000C4 BCC8CDCDCDCDCDBC20-
    39 000000CD C8CDBC2020C8CDBC   
    40                                  
    41                                  cVersionLen:                            ; 版数文字列の長さ
    42 000000D5 1200                            DW      18
    43                                  
    44                                  cVersionStr:                            ; 版数文字列の内容
    45 000000D7 6D6173682073797374-             DB      "mash system v0.2.1"
    45 000000E0 656D2076302E322E31 
    46                                  
    47                                  ; //////////////////////////////////////////////////////////////////////////// ;
    48                                  ; --- 変数 ---
    49                                  ;  ██████╗████████╗ █████╗ ████████╗██╗ ██████╗
    50                                  ; ██╔════╝╚══██╔══╝██╔══██╗╚══██╔══╝██║██╔════╝
    51                                  ; ╚█████╗    ██║   ██║  ██║   ██║   ██║██║     
    52                                  ;  ╚═══██    ██║   ███████║   ██║   ██║██║     
    53                                  ; ██████╔╝   ██║   ██╔══██║   ██║   ██║╚██████╗
    54                                  ; ╚═════╝    ╚═╝   ╚═╝  ╚═╝   ╚═╝   ╚═╝ ╚═════╝
    55                                  ; //////////////////////////////////////////////////////////////////////////// ;
    56                                  
    57                                  ; 表示関連
    58                                  sXpos:
    59 000000E9 00                              DB      0x00                    ; 表示xカーソル
    60                                  sYpos:
    61 000000EA 09                              DB      0x09                    ; 表示yカーソル
    62                                  sColorNormal:
    63 000000EB 0F                              DB      0x0f                    ; 表示色(初期値: 白)
    64                                  sColorError:
    65 000000EC 01                              DB      0x01                    ; 表示色(初期値: 赤?)
    66                                  
    67                                  ; 入出力関連
    68                                  sStdInput:                              ; 標準入力
    69 000000ED 00                              DB      FD_KEYBORD
    70                                  sStdOut:                                ; 標準出力
    71 000000EE 01                              DB      FD_DISPLAY
    72                                  sStdErrout:                             ; 標準エラー出力
    73 000000EF 01                              DB      FD_DISPLAY
    74                                  sOneLineBuf:
    75 000000F0 00<rep 100h>                    times   0x0100 DB 0x00          ; 入力バッファ(256byte)
    76                                  sOneLineSeek:
    77 000001F0 0000                            DW      0x0000                  ; シークオフセット
    78                                  
    79                                  sNowDir:
    80 000001F2 1500                            DW      DIR_ROOT                ; 現在いるディレクトリ
    81                                  
    82                                  ; シェル変数関連
    83                                  sTopValAddr:
    84 000001F4 0000                            DW      0x0000                  ; シェル変数の連結リストの先頭アドレス
    85                                  
    86                                  ; //////////////////////////////////////////////////////////////////////////// ;
    87                                  ; --- 初期化プログラム ---
    88                                  ; ██╗███╗  ██╗██╗████████╗
    89                                  ; ██║████╗ ██║██║╚══██╔══╝
    90                                  ; ██║██╔██╗██║██║   ██║   
    91                                  ; ██║██║╚████║██║   ██║   
    92                                  ; ██║██║ ╚███║██║   ██║   
    93                                  ; ╚═╝╚═╝  ╚══╝╚═╝   ╚═╝   
    94                                  ; //////////////////////////////////////////////////////////////////////////// ;
    95                                  
    96                                  mashInit:
    97 000001F6 B80000                          MOV     AX, 0x0000              ; レジスタセット
    98 000001F9 8ED8                            MOV     DS, AX
    99 000001FB 8ED0                            MOV     SS, AX
   100 000001FD 8EC0                            MOV     ES, AX
   101 000001FF BCFF3F                          MOV     SP, 0x3fff              ; ｾｸﾞﾎﾟ
   102                                  
   103 00000202 E80107                          CALL    rInitMalloc
   104                                          
   105                                  %ifdef __DEBUG
   106                                          ; AX, BX, CX, DX, SI, DI, BP, SP, DS, ES, SS
   107                                          ;MOV     AX, 0x1234
   108                                          ;MOV     BX, 0x2345
   109                                          ;MOV     CX, 0x3456
   110                                          ;MOV     DX, 0x4567
   111                                          ;MOV     SI, 0x5678
   112                                          ;MOV     DI, 0x6789
   113                                          ;MOV     BP, 0x789a
   114                                  %endif
   115                                  
   116 00000205 E84B08                          CALL    dbgRegDump
   117                                  
   118                                  %ifdef __DEBUG
   119                                          ;MOV     AX, 0x0000
   120                                          ;MOV     DS, AX
   121                                          ;MOV     SS, AX
   122                                          ;MOV     ES, AX
   123                                  %endif
   124                                  
   125 00000208 E81207                          CALL    cmdVer                  ; ロゴ+版数表示
   126                                  
   127                                  %ifdef __DEBUG
   128                                          ; スクロールテスト
   129                                  ;.dbgLoop:
   130                                          ;MOV     AH, 0x00
   131                                          ;INT     0x16
   132                                  
   133                                          ;MOV     AH, 0x06
   134                                          ;MOV     AL, 0x01
   135                                          ;MOV     BH, 0x07
   136                                          ;MOV     CX, 0x0000
   137                                          ;MOV     DH, 24
   138                                          ;MOV     DL, 79
   139                                          ;INT     0x10
   140                                  
   141                                          ;JMP     .dbgLoop
   142                                  %endif
   143                                  
   144 0000020B C706[F401]0000                  MOV WORD [sTopValAddr], 0x0000       ; 初期化
   145                                  
   146 00000211 B400                            MOV     AH, 0x00
   147 00000213 BE[1B02]                        MOV     SI, .aInitialValue
   148                                  
   149                                          ;PUSH    AX
   150                                          ;MOV     AX, SI
   151                                          ;CALL    dbgPrint16bit           ; デバッグ
   152                                          ;POP     AX
   153                                  
   154 00000216 E89600                          CALL    sysDim
   155                                  
   156                                  %ifdef __DEBUG_DONE
   157                                          ; 番兵のシェル変数を設定
   158                                          MOV     CX, 0x0010
   159                                          CALL    sysMalloc
   160                                  
   161                                          MOV WORD [sTopValAddr], BP      ; 変数の先頭アドレス
   162                                  
   163                                          MOV BYTE [BP], 14
   164                                  
   165                                          ADD     BP, 1                   ; sTopValAddr + 1
   166                                  
   167                                          MOV BYTE [BP], 0x00             ; 変数型
   168                                  
   169                                          ADD     BP, 1                   ; sTopValAddr + 2
   170                                  
   171                                          MOV     SI, .aInitialValue
   172                                          MOV     DI, BP
   173                                          MOV     CX, 8
   174                                          CALL    libMemcpy               ; 変数名
   175                                  
   176                                          ADD     BP, 8                   ; sTopValAddr + 10
   177                                  
   178                                          MOV WORD [BP], 0x1234           ; 変数値
   179                                  
   180                                          ADD     BP, 2                   ; sTopValAddr + 12
   181                                  
   182                                          MOV WORD [BP], 0x0000           ; 次の変数アドレス(null設定)
   183                                  
   184                                          ; デバッグ
   185                                          DEBUG_REGISTER_DUMP 16, [sTopValAddr]
   186                                  %endif
   187                                          
   188 00000219 EB08                            JMP     mashLoop                ; ループ処理へ移行
   189                                  
   190                                  .aInitialValue:                         ; 番兵の変数名
   191 0000021B 5F5F696E69742020                DB      "__init  "
   192                                  
   193                                  ; //////////////////////////////////////////////////////////////////////////// ;
   194                                  ; --- ループプログラム ---
   195                                  ; ██╗      ██████╗  ██████╗ ██████╗ 
   196                                  ; ██║     ██╔═══██╗██╔═══██╗██╔══██╗
   197                                  ; ██║     ██║   ██║██║   ██║██████╔╝
   198                                  ; ██║     ██║   ██║██║   ██║██╔═══╝ 
   199                                  ; ███████╗╚██████╔╝╚██████╔╝██║     
   200                                  ; ╚══════╝ ╚═════╝  ╚═════╝ ╚═╝     
   201                                  ; //////////////////////////////////////////////////////////////////////////// ;
   202                                  
   203                                  mashLoop:
   204                                          ; シェル変数の定義
   205 00000223 B430                            MOV     AH, "0"
   206                                  .dimLoop:
   207                                          ; 設定する
   208 00000225 50                              PUSH    AX
   209                                  
   210 00000226 B412                            MOV     AH, 0x12
   211 00000228 B020                            MOV     AL, 0x20
   212 0000022A 8B36[A702]                      MOV     SI, [.aTokenName]
   213                                  
   214 0000022E E87E00                          CALL    sysDim
   215                                  
   216                                          ; ループ制御
   217 00000231 58                              POP     AX
   218 00000232 80FC30                          CMP     AH, "0"
   219 00000235 7404                            JZ      .input
   220 00000237 FEC4                            INC     AH
   221 00000239 EBEA                            JMP     .dimLoop
   222                                  
   223                                  .input:
   224                                          ;CALL    libSetCursolNextLine    ; 改行
   225                                          ;CALL    rOneLineClear           ; 
   226                                  
   227                                          ; デバッグ(512バイト)
   228                                          DEBUG_REGISTER_DUMP 0x0100, 0x8000
   112 0000023B 50                  <1>  PUSH AX
   113 0000023C 57                  <1>  PUSH DI
   114                              <1> 
   115 0000023D B80001              <1>  MOV AX, %1
   116 00000240 BF0080              <1>  MOV DI, %2
   117 00000243 E88907              <1>  CALL dbgDump
   118                              <1> 
   119 00000246 5F                  <1>  POP DI
   120 00000247 58                  <1>  POP AX
   229                                          
   230 00000248 B05C                            MOV     AL, "\"        
   231 0000024A E86205                          CALL    libPutchar
   232 0000024D E82004                          CALL    libSetCursolNextCol
   233 00000250 B03E                            MOV     AL, ">"
   234 00000252 E85A05                          CALL    libPutchar
   235 00000255 E81804                          CALL    libSetCursolNextCol
   236                                  .inputLoop:
   237                                          ; 入力ループ(1文字事にループ)
   238                                  
   239                                          ; debug ---->
   240                                          ; in  : AX      ダンプするバイト数
   241                                          ;     : DS:DI   ダンプ開始アドレス
   242                                          ;MOV     DI, sOneLineBuf-8
   243                                          ;CALL    dbgDump
   244                                          ; <---- debug
   245                                  
   246 00000258 E83406                          CALL    rOneLineInput           ; キーボード入力 → バッファ+出力
   247                                          ;PUSH    AX
   248                                          ;POP     AX
   249 0000025B 80FC00                          CMP     AH, 0x00
   250 0000025E 74F8                            JZ      .inputLoop              ; 続ける
   251                                  
   252                                  .parseBuf:
   253                                          ; バッファ解析
   254 00000260 B80000                          MOV     AX, 0x0000
   255                                  
   256                                          ; puts
   257 00000263 BD[9B02]                        MOV     BP, .aTestPuts          ; 識別文字列
   258 00000266 E86B05                          CALL    libPuts
   259 00000269 BD[F000]                        MOV     BP, sOneLineBuf         ; 入力バッファ
   260 0000026C E86505                          CALL    libPuts
   261                                  
   262                                          ; sparse
   263 0000026F BD[A002]                        MOV     BP, .aTestsParse        ; 識別文字列
   264 00000272 E85F05                          CALL    libPuts
   265 00000275 BD[F000]                        MOV     BP, sOneLineBuf         ; 入力バッファ
   266 00000278 E87505                          CALL    libsParse
   267                                  
   268                                          ; トークン分離
   269 0000027B B90001                          MOV     CX, 0x0100              ; メモリ確保
   270 0000027E E8C401                          CALL    sysMalloc
   271 00000281 55                              PUSH    BP
   272                                  
   273 00000282 BE[F000]                        MOV     SI, sOneLineBuf
   274 00000285 89EF                            MOV     DI, BP
   275 00000287 B90001                          MOV     CX, 0x0100
   276                                  
   277 0000028A E83D04                          CALL    libMemcpy
   278                                  
   279 0000028D E84405                          CALL    libPuts
   280                                  
   281 00000290 5D                              POP     BP
   282 00000291 E84D02                          CALL    sysFree
   283                                  
   284                                          ; バッファクリア
   285 00000294 E85106                          CALL    rOneLineClear
   286 00000297 EB8A                            JMP     mashLoop
   287                                  
   288                                          ; バッファトークン用の変数を解放
   289                                  
   290                                          
   291 00000299 EB88                            JMP     mashLoop                ; 永遠にループする
   292                                  .aTestPuts:
   293 0000029B 7075747300                      DB      "puts", 0x00
   294                                  .aTestsParse:
   295 000002A0 73706172736500                  DB      "sparse", 0x00
   296                                  
   297                                  .aTokenName:                            ; 入力バッファトークン変数名
   298 000002A7 5F627566746F6B                  DB      "_buftok"
   299                                  .aTokenNum:                             ; 連番(aTokenNameと連続したメモリに置くこと)
   300 000002AE 30                              DB      "0"
   301                                  
   302                                  ; //////////////////////////////////////////////////////////////////////////// ;
   303                                  ; --- ビルトインコマンド ---
   304                                  ;  ██████╗ ██████╗ ███╗   ███╗███╗   ███╗ █████╗ ███╗  ██╗██████╗ 
   305                                  ; ██╔════╝██╔═══██╗████╗ ████║████╗ ████║██╔══██╗████╗ ██║██╔══██╗
   306                                  ; ██║     ██║   ██║██╔████╔██║██╔████╔██║██║  ██║██╔██╗██║██║  ██║
   307                                  ; ██║     ██║   ██║██║╚██╔╝██║██║╚██╔╝██║███████║██║╚████║██║  ██║
   308                                  ; ╚██████╗╚██████╔╝██║ ╚═╝ ██║██║ ╚═╝ ██║██╔══██║██║ ╚███║██████╔╝
   309                                  ;  ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚══╝╚═════╝ 
   310                                  ; //////////////////////////////////////////////////////////////////////////// ;
   311                                  
   312                                  ; dim コマンド
   313                                  ; シェル変数を追加する
   314                                  ; 最新変数に位置し、次の変数へのチェーンポインタに現在の最新変数が格納される。
   315                                  ; 重複した同じ変数名を許容する(undimするまで最新以外の変数へはアクセスできなくなる)
   316                                  ; in  : AH      変数型
   317                                  ;               0x00: 符号なし整数型
   318                                  ;               0x01: 符号付き整数型
   319                                  ;               0x02: 文字型
   320                                  ;               0x10: 符号なし整数配列
   321                                  ;               0x12: 文字配列型
   322                                  ;       AL      要素数(配列型の場合のみ有効)
   323                                  ;       SI      変数文字列先頭アドレス
   324                                  ; out : CH      エラーコード
   325                                  sysDim:
   326 000002AF E8CD06                          CALL    rPushReg                ; レジスタ退避
   327                                  
   328                                          ; 確保メモリ確認 ---->
   329 000002B2 50                              PUSH    AX
   330 000002B3 B80100                          MOV WORD AX, 0x0001
   331 000002B6 E8E707                          CALL    dbgPrint16bit           ; デバッグ
   332 000002B9 58                              POP     AX
   333                                  
   334 000002BA 50                              PUSH    AX
   335 000002BB 89F0                            MOV WORD AX, SI
   336 000002BD E8E007                          CALL    dbgPrint16bit           ; デバッグ
   337 000002C0 58                              POP     AX
   338                                          ; <----
   339                                  
   340 000002C1 C606[0204]00                    MOV BYTE [.aRet], RET_OK        ; 戻り値設定
   341                                  
   342                                          ; 格納できる内容はこの時点で入れておく
   343 000002C6 8826[F403]                      MOV BYTE [.aType], AH
   344 000002CA A2[FD03]                        MOV BYTE [.aLen], AL            ; 使わない型の場合参照しないので一旦入れておく
   345                                  
   346                                          ; デバッグ ---->
   347                                          DEBUG_REGISTER_DUMP 8, SI
   112 000002CD 50                  <1>  PUSH AX
   113 000002CE 57                  <1>  PUSH DI
   114                              <1> 
   115 000002CF B80800              <1>  MOV AX, %1
   116 000002D2 89F7                <1>  MOV DI, %2
   117 000002D4 E8F806              <1>  CALL dbgDump
   118                              <1> 
   119 000002D7 5F                  <1>  POP DI
   120 000002D8 58                  <1>  POP AX
   348                                          ; <----
   349                                  
   350                                          MACRO_MEMCPY .aName, SI, 8
    54 000002D9 57                  <1>  PUSH DI
    55 000002DA 56                  <1>  PUSH SI
    56 000002DB 51                  <1>  PUSH CX
    57                              <1> 
    58 000002DC BF[F503]            <1>  MOV DI, %1
    59 000002DF 89F6                <1>  MOV SI, %2
    60 000002E1 B90800              <1>  MOV CX, %3
    61                              <1> 
    62 000002E4 E8E303              <1>  CALL libMemcpy
    63                              <1> 
    64 000002E7 59                  <1>  POP CX
    65 000002E8 5E                  <1>  POP SI
    66 000002E9 5F                  <1>  POP DI
   351                                  
   352                                          ; デバッグ ---->
   353                                          DEBUG_REGISTER_DUMP 8, .aName
   112 000002EA 50                  <1>  PUSH AX
   113 000002EB 57                  <1>  PUSH DI
   114                              <1> 
   115 000002EC B80800              <1>  MOV AX, %1
   116 000002EF BF[F503]            <1>  MOV DI, %2
   117 000002F2 E8DA06              <1>  CALL dbgDump
   118                              <1> 
   119 000002F5 5F                  <1>  POP DI
   120 000002F6 58                  <1>  POP AX
   354                                          ; <----
   355                                  
   356                                          ; 変数を記録するメモリサイズを計算する
   357                                          ; サイズが判明した後のコールバック関数も登録しておく
   358 000002F7 8A26[F403]                      MOV BYTE AH, [.aType]
   359 000002FB 80FC00                          CMP     AH, TYPE_UINT
   360 000002FE 7416                            JZ      .type_uint
   361 00000300 80FC01                          CMP     AH, TYPE_SINT
   362 00000303 741F                            JZ      .type_sint
   363 00000305 80FC02                          CMP     AH, TYPE_CHAR
   364 00000308 7428                            JZ      .type_char
   365 0000030A 80FC10                          CMP     AH, TYPE_ARR
   366 0000030D 7431                            JZ      .type_arr
   367 0000030F 80FC12                          CMP     AH, TYPE_STR
   368 00000312 743F                            JZ      .type_str
   369 00000314 EB4E                            JMP     .type_error             ; 型エラー
   370                                  
   371                                  .type_uint:                             ; 符号なし整数型
   372 00000316 C606[F303]0E                    MOV BYTE [.aSize], 14           ; 整数型は14バイト固定
   373 0000031B BE[BD03]                        MOV WORD SI, .fill_uint
   374 0000031E 8936[F103]                      MOV WORD [.func_call], SI       ; コールバックアドレス登録
   375 00000322 EB47                            JMP     .alloc_mem
   376                                  .type_sint:                             ; 符号付き整数型
   377 00000324 C606[F303]0E                    MOV BYTE [.aSize], 14           ; 整数型は14バイト固定
   378 00000329 BE[BD03]                        MOV WORD SI, .fill_sint
   379 0000032C 8936[F103]                      MOV WORD [.func_call], SI
   380 00000330 EB39                            JMP     .alloc_mem
   381                                  .type_char:
   382 00000332 C606[F303]0D                    MOV BYTE [.aSize], 13           ; 文字型は13バイト固定
   383 00000337 BE[BD03]                        MOV WORD SI, .fill_char
   384 0000033A 8936[F103]                      MOV WORD [.func_call], SI
   385 0000033E EB2B                            JMP     .alloc_mem
   386                                  .type_arr:
   387 00000340 A0[FD03]                        MOV BYTE AL, [.aLen]            ; 整数配列のサイズは 2n+14 バイト
   388 00000343 D0E0                            SHL     AL, 1
   389 00000345 040E                            ADD     AL, 14
   390 00000347 A2[F303]                        MOV BYTE [.aSize], AL
   391 0000034A BE[BF03]                        MOV WORD SI, .fill_arr
   392 0000034D 8936[F103]                      MOV WORD [.func_call], SI
   393 00000351 EB18                            JMP     .alloc_mem
   394                                  .type_str:
   395 00000353 A0[FD03]                        MOV BYTE AL, [.aLen]            ; 文字配列のサイズは n+14 バイト
   396 00000356 040E                            ADD     AL, 14
   397 00000358 A2[F303]                        MOV BYTE [.aSize], AL
   398 0000035B BE[BF03]                        MOV WORD SI, .fill_str
   399 0000035E 8936[F103]                      MOV WORD [.func_call], SI
   400 00000362 EB07                            JMP     .alloc_mem
   401                                  .type_error:
   402 00000364 C606[0204]01                    MOV BYTE [.aRet], RET_NG_PRM
   403 00000369 EB7E                            JMP     .exit
   404                                  
   405                                  .alloc_mem:
   406                                          ; 必要な分のメモリを動的確保する
   407                                          ; free時に断片化が起きないよう一括取得を優先する
   408 0000036B B500                            MOV     CH, 0x00
   409 0000036D 8A0E[F303]                      MOV BYTE CL, [.aSize]
   410 00000371 E8D100                          CALL    sysMalloc               ; 確保メモリはBP
   411 00000374 892E[FE03]                      MOV WORD [.aAddr], BP           ; 先頭アドレス保存
   412                                  
   413                                          ; 現在の最新アドレスを一つ前へ
   414 00000378 8B36[F401]                      MOV WORD SI, [sTopValAddr]
   415 0000037C 8936[0004]                      MOV WORD [.aNext], SI
   416                                  
   417                                          ; 確保メモリ確認 ---->
   418 00000380 50                              PUSH    AX
   419 00000381 B80200                          MOV WORD AX, 0x0002
   420 00000384 E81907                          CALL    dbgPrint16bit           ; デバッグ
   421 00000387 58                              POP     AX
   422                                  
   423 00000388 50                              PUSH    AX
   424 00000389 A1[FE03]                        MOV WORD AX, [.aAddr]
   425 0000038C E81107                          CALL    dbgPrint16bit           ; デバッグ
   426 0000038F 58                              POP     AX
   427                                          ; <----
   428                                  
   429                                  .fill_common1:                          ; 代入処理(共通)
   430                                          ; データを格納していく
   431 00000390 8B2E[FE03]                      MOV WORD BP, [.aAddr]           ; 先頭アドレス
   432 00000394 8A26[F303]                      MOV BYTE AH, [.aSize]           ; 変数型
   433                                  
   434 00000398 886600                          MOV BYTE [BP], AH               ; BP: 変数サイズ
   435 0000039B 83C501                          ADD     BP, 1
   436 0000039E 8A26[F403]                      MOV BYTE AH, [.aType]
   437 000003A2 886600                          MOV BYTE [BP], AH               ; BP+1: 変数型
   438 000003A5 83C501                          ADD     BP, 1
   439                                  
   440                                          MACRO_MEMCPY BP, .aName, 8      ; BP+2: 変数名
    54 000003A8 57                  <1>  PUSH DI
    55 000003A9 56                  <1>  PUSH SI
    56 000003AA 51                  <1>  PUSH CX
    57                              <1> 
    58 000003AB 89EF                <1>  MOV DI, %1
    59 000003AD BE[F503]            <1>  MOV SI, %2
    60 000003B0 B90800              <1>  MOV CX, %3
    61                              <1> 
    62 000003B3 E81403              <1>  CALL libMemcpy
    63                              <1> 
    64 000003B6 59                  <1>  POP CX
    65 000003B7 5E                  <1>  POP SI
    66 000003B8 5F                  <1>  POP DI
   441                                  
   442 000003B9 FF26[F103]                      JMP     [.func_call]            ; コールバック呼び出し(void)
   443                                  
   444                                  .fill_uint:                             ; 符号なし整数 代入コールバック
   445                                  .fill_sint:                             ; 符号付き整数 代入コールバック
   446                                  .fill_char:                             ; 文字 代入コールバック
   447 000003BD EB10                            JMP .fill_common2
   448                                  
   449                                  .fill_arr:                              ; 配列 代入コールバック
   450                                  .fill_str:                              ; 文字列 代入コールバック
   451 000003BF 8B2E[FE03]                      MOV WORD BP, [.aAddr]           ; 先頭アドレス
   452 000003C3 8A26[FD03]                      MOV BYTE AH, [.aLen]
   453 000003C7 83C50A                          ADD     BP, 10
   454 000003CA 886600                          MOV BYTE [BP], AH               ; BP+10: 要素数
   455 000003CD EB00                            JMP .fill_common2
   456                                  
   457                                  .fill_common2:
   458 000003CF 8B2E[FE03]                      MOV WORD BP, [.aAddr]           ; 先頭アドレス
   459 000003D3 8A26[F303]                      MOV BYTE AH, [.aSize]
   460 000003D7 00E3                            ADD     BL, AH
   461 000003D9 83ED02                          SUB     BP, 2
   462 000003DC A1[F401]                        MOV WORD AX, [sTopValAddr]      ; BP+サイズ-2: 次の変数へのポインタ
   463                                  
   464                                          ; 宣言した変数のポインタを最新ポインタに記録する
   465 000003DF 8B2E[FE03]                      MOV WORD BP, [.aAddr]
   466 000003E3 892E[F401]                      MOV WORD [sTopValAddr], BP
   467 000003E7 EB00                            JMP     .exit
   468                                  
   469                                  .exit:
   470 000003E9 E8B005                          CALL    rPopReg                 ; レジスタ取得
   471 000003EC 8A2E[0204]                      MOV BYTE CH, [.aRet]
   472 000003F0 C3                              RET
   473                                  .func_call:                             ; コールバックアドレス
   474 000003F1 0000                            DW      0x0000
   475                                  .aSize:                                 ; 変数メモリサイズ
   476 000003F3 00                              DB      0x00
   477                                  .aType:                                 ; 変数型
   478 000003F4 00                              DB      0x00
   479                                  .aName:                                 ; 変数名(最大8文字)
   480 000003F5 0000000000000000                DB      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
   481                                  .aLen:                                  ; 要素数
   482 000003FD 00                              DB      0x00
   483                                  .aAddr:                                 ; 本変数の先頭アドレス
   484 000003FE 0000                            DW      0x0000
   485                                  .aNext:                                 ; 次の変数へのチェーンアドレス
   486 00000400 0000                            DW      0x0000
   487                                  .aRet:                                  ; エラーコード
   488 00000402 00                              DB      0x00
   489                                  
   490                                  ; undim コマンド
   491                                  ; シェル変数を解放する
   492                                  sysUndim:
   493 00000403 E87905                          CALL    rPushReg                ; レジスタ退避
   494                                  
   495 00000406 E89305                          CALL    rPopReg                 ; レジスタ取得
   496 00000409 C3                              RET
   497                                  
   498                                  ; set コマンド
   499                                  ; シェル変数の値を更新する
   500                                  sysSet:
   501 0000040A E87205                          CALL    rPushReg                ; レジスタ退避
   502                                  
   503 0000040D E88C05                          CALL    rPopReg                 ; レジスタ取得
   504 00000410 C3                              RET
   505                                  
   506                                  ; get コマンド
   507                                  ; シェル変数の値を取得する
   508                                  sysGet:
   509 00000411 E86B05                          CALL    rPushReg                ; レジスタ退避
   510                                  
   511 00000414 E88505                          CALL    rPopReg                 ; レジスタ取得
   512 00000417 C3                              RET
   513                                  
   514                                  ; dir コマンド
   515                                  ; 現在のディレクトリのフォルダ、ファイルを表示する
   516                                  sysDir:
   517 00000418 E86405                          CALL    rPushReg                ; レジスタ退避
   518                                  
   519 0000041B B90002                          MOV     CX, 0x0200              ; 現在のディレクトリ用のメモリを取得
   520 0000041E E82400                          CALL    sysMalloc
   521 00000421 892E[3304]                      MOV WORD [.allocAddr1], BP
   522 00000425 B90002                          MOV     CX, 0x0200              ; リンク先のディレクトリ用のメモリを取得
   523 00000428 E81A00                          CALL    sysMalloc
   524 0000042B 892E[3504]                      MOV WORD [.allocAddr2], BP
   525                                  
   526 0000042F E86A05                          CALL    rPopReg                 ; レジスタ取得
   527 00000432 C3                              RET
   528                                  .allocAddr1:
   529 00000433 0000                            DB      0x00, 0x00
   530                                  .allocAddr2:
   531 00000435 0000                            DB      0x00, 0x00
   532                                  
   533                                  ; pwd コマンド
   534                                  ; 現在のディレクトリを標準出力に渡す
   535                                  sysPwd:
   536 00000437 E84505                          CALL    rPushReg                ; レジスタ退避
   537 0000043A E85F05                          CALL    rPopReg                 ; レジスタ取得
   538 0000043D C3                              RET
   539                                  
   540                                  ; echo コマンド
   541                                  ; 文字列の表示(エスケープシーケンスあり)
   542                                  ; in  : BP      表示する文字列の先頭ポインタ
   543                                  ; out : 画面表示
   544                                  sysEcho:
   545 0000043E E83E05                          CALL    rPushReg                ; レジスタ退避
   546 00000441 E85805                          CALL    rPopReg                 ; レジスタ取得
   547 00000444 C3                              RET
   548                                  
   549                                  ; malloc コマンド
   550                                  ; 指定されたバイト数の確保した先頭アドレスを返却する
   551                                  ; 実際の確保は16バイト単位で行われる
   552                                  ; 一度に確保できるのは 4080(255* 16)バイト まで
   553                                  ;
   554                                  ; アロケーションメモリ: 0x0800 ~ 0x0fff
   555                                  ; アロケーションテーブル: 0x8000 ~ 0xffff
   556                                  ;
   557                                  ; in  : CX      確保したいメモリ容量(バイト)
   558                                  ; out : AX      結果 0成功 1失敗
   559                                  ;     : BP      確保した先頭ポインタ(確保に成功した場合)
   560                                  sysMalloc:
   561 00000445 E83705                          CALL    rPushReg                ; レジスタ退避
   562                                  
   563 00000448 81F90010                        CMP     CX, 0x1000              ; 確保メモリ上限チェック
   564 0000044C 737F                            JAE     .retError
   565 0000044E 83F900                          CMP     CX, 0x0000              ; 0バイトかチェック
   566 00000451 747A                            JZ      .retError
   567 00000453 83C10F                          ADD     CX, 0x000f              ; 確保するブロック数(1ブロック16バイト) = (確保したいバイト + 15) /16
   568 00000456 C1E904                          SHR     CX, 0x04
   569 00000459 880E[DE04]                      MOV BYTE [.aSize], CL
   570 0000045D C706[DB04]0008                  MOV WORD [.aFAdr], 0x0800       ; テーブルの先頭ポインタは 0x0800
   571 00000463 C606[DD04]00                    MOV BYTE [.aCnt], 0x00
   572 00000468 C706[DF04]0008                  MOV WORD [.aRet], 0x0800
   573                                  .mallocLoop:
   574 0000046E 8B3E[DB04]                      MOV WORD DI, [.aFAdr]           ; シークしている番地が0か確認
   575 00000472 8A25                            MOV BYTE AH, [DI]
   576 00000474 80FC00                          CMP     AH, 0x00
   577 00000477 7419                            JZ      .cntChk
   578 00000479 C606[DD04]00                    MOV BYTE [.aCnt], 0x00         ; シーク番地が0ではないので連続数をリセット
   579 0000047E A1[DB04]                        MOV WORD AX, [.aFAdr]           ; アロケーションテーブルをシーク
   580 00000481 40                              INC     AX
   581 00000482 A3[DB04]                        MOV WORD [.aFAdr], AX
   582 00000485 A3[DF04]                        MOV WORD [.aRet], AX            ; シーク以前には確保できる領域がないため次へ
   583                                  .exitChk:
   584 00000488 A1[DB04]                        MOV WORD AX, [.aFAdr]           ; テーブルの末尾まで行ったらもう見込みなし
   585 0000048B 3D0010                          CMP     AX, 0x1000              ; 末尾は 0x0fff
   586 0000048E 75DE                            JNZ     .mallocLoop             ; 末尾ではないなら次の1バイトを
   587 00000490 EB3B                            JMP     .retError
   588                                  .cntChk:
   589 00000492 8A3E[DD04]                      MOV BYTE BH, [.aCnt]            ; 連続空きブロックカウントをカウントアップ
   590 00000496 FEC7                            INC     BH                      ; AHには連続空きブロック
   591 00000498 883E[DD04]                      MOV BYTE [.aCnt], BH
   592 0000049C 8A2E[DE04]                      MOV BYTE CH, [.aSize]           ; 連続空きブロックで注文した領域を充足するか？
   593 000004A0 38EF                            CMP     BH, CH                  ; ALには注文されたブロック数(AHには連続空きブロック)
   594 000004A2 7409                            JZ      .fillTbl
   595 000004A4 A1[DB04]                        MOV WORD AX, [.aFAdr]           ; まだ充足しないため検索を続ける(連続空きブロックは継続)
   596 000004A7 40                              INC     AX
   597 000004A8 A3[DB04]                        MOV WORD [.aFAdr], AX
   598 000004AB EBDB                            JMP     .exitChk                ; 末尾チェックへ
   599                                  .fillTbl:
   600 000004AD A1[DB04]                        MOV WORD AX, [.aFAdr]           ; 連続空きブロックの先頭アドレスを取得
   601 000004B0 89C7                            MOV     DI, AX                  ; 以後空きブロックのアドレスは DI にて参照
   602 000004B2 8A26[DD04]                      MOV BYTE AH, [.aCnt]            ; 以後注文されたブロック数は AH にて参照
   603 000004B6 B100                            MOV     CL, 0x00
   604                                  .fillLoop:
   605 000004B8 FEC1                            INC     CL                      ; aCnt++
   606 000004BA 3E880D                          MOV BYTE [DS:DI], CL            ; free用に意味のある値を格納
   607 000004BD 4F                              DEC     DI                      ; aFAdr--
   608 000004BE 38CC                            CMP     AH, CL                  ; 注文されたブロック数だけ書き込んだら終了
   609 000004C0 75F6                            JNZ     .fillLoop
   610 000004C2 A1[DF04]                        MOV WORD AX, [.aRet]            ; 呼び出し元に返却するのは (連続空きブロックの先頭アドレス) * 16
   611 000004C5 C1E004                          SHL     AX, 0x04
   612 000004C8 A3[DF04]                        MOV WORD [.aRet], AX
   613 000004CB EB06                            JMP     .return
   614                                  .retError:
   615 000004CD C706[DF04]FFFF                  MOV WORD [.aRet], 0xffff        ; とりあえずゴミデータ
   616                                  .return:
   617 000004D3 E8C604                          CALL    rPopReg                 ; レジスタ取得
   618 000004D6 8B2E[DF04]                      MOV WORD BP, [.aRet]            ; 取得した先頭アドレスを格納
   619                                  
   620 000004DA C3                              RET                             ; 呼び出し元へ     
   621                                  .aFAdr:                                 ; テーブル内シークアドレス
   622 000004DB 0000                            DB      0x00, 0x00
   623                                  .aCnt:                                  ; 現時点の連続空きブロック
   624 000004DD 00                              DB      0x00
   625                                  .aSize:                                 ; 検索するべき連続空きブロック
   626 000004DE 00                              DB      0x00
   627                                  .aRet:                                  ; 返却するアロケーションメモリアドレス
   628 000004DF 0000                            DB      0x00, 0x00
   629                                  
   630                                  ; free コマンド
   631                                  ; 指定されたアドレスを含む確保領域を解放する
   632                                  ; 実際の確保は16バイト単位で行われる
   633                                  ;
   634                                  ; アロケーションメモリ: 0x1000:0x0000 ~ 0x1000:0xffff
   635                                  ; アロケーションテーブル: 0x0000:0x1000 ~ 0x0000:0x1fff
   636                                  ;
   637                                  ; in  : BP      解放したいアドレス(確保した領域内ならどこでも)
   638                                  ; out : AX      結果 0成功 1失敗
   639                                  sysFree:
   640 000004E1 E89B04                          CALL    rPushReg                ; レジスタ退避
   641 000004E4 89EF                            MOV     DI, BP                  ; DI ← (BP / 16)
   642 000004E6 C1EF04                          SHR     DI, 0x04
   643                                  
   644                                  .freeLoop:                              ; 確保した先頭まで戻る
   645 000004E9 8A25                            MOV BYTE AH, [DI]            ; sTbl[DI]
   646 000004EB 80FC00                          CMP     AH, 0x00                ; 値が 0x00 なら異常メモリを入力している
   647 000004EE 7409                            JZ      .next
   648 000004F0 C60500                          MOV BYTE [DI], 0x00
   649 000004F3 47                              INC     DI
   650 000004F4 80FC01                          CMP     AH, 0x01                ; 値が 0x01 まで続ける
   651 000004F7 75F0                            JNZ     .freeLoop
   652                                  .next:
   653 000004F9 E8A004                          CALL    rPopReg                 ; レジスタ取得
   654 000004FC C3                              RET
   655                                  
   656                                  ; printf 等の文字列解析+文字出力(エスケープシーケンスあり)
   657                                  ; 256文字まで(終端文字含む)
   658                                  ; %c: 文字, %s: 文字列, %d: 10進数, %x: 16進数(小文字), %X: 16進数(大文字)
   659                                  ; \a: 警報音, \n: 復帰改行, \r: 復帰, \t: タブ, \o: 更新なしで次の文字へ, \\, \?, \', \": 1文字, \0: 文字列終了
   660                                  ; \Uxx: カーソルをxx(10新2桁)行上, \Dxx: 下, \Rxx: 右, \Lxx: 左
   661                                  ; \Xxx: カーソルのx座標をxx(10新2桁)に移動, \Yxx: カーソルのx座標をxx(10新2桁)に移動, 
   662                                  ; in  : AX 出力先ファイルディスクリプタ
   663                                  ;     : SI 文字列の先頭ポインタ
   664                                  ;     : DI 変数の先頭ポインタ(DI:1つ目の変数, DI+4:2つ目の変数...)
   665                                  sysPrintf:
   666 000004FD E87F04                          CALL    rPushReg                ; レジスタ退避
   667                                  
   668 00000500 E89904                          CALL    rPopReg                 ; レジスタ取得
   669 00000503 C3                              RET
   670                                  
   671                                  ; 文字列の表示
   672                                  ; 終端文字(0x00)を確認するまで文字を表示し続ける
   673                                  ; in  : BX      表示する文字列
   674                                  ;       DS:BX   データポインタ
   675                                  ; out : AX      表示結果
   676                                  ;                   0: 成功
   677                                  ;                   1: 256文字以上の文字列を表示しようとした
   678                                  ;                   2: その他の失敗
   679                                  sysPrint:
   680 00000504 E87804                          CALL    rPushReg                ; レジスタ退避
   681                                  
   682                                  
   683                                  
   684 00000507 E89204                          CALL    rPopReg                 ; レジスタ取得
   685 0000050A C3                              RET
   686                                  
   687                                  ; 単一の文字出力
   688                                  ; カーソル位置の更新も行う
   689                                  ; in  : AL      表示する文字
   690                                  sysPutChar:
   691                                  
   692                                  ; //////////////////////////////////////////////////////////////////////////// ;
   693                                  ; --- ライブラリ ---
   694                                  ; ██╗     ██╗██████╗ ██████╗  █████╗ ██████╗ ██╗   ██╗
   695                                  ; ██║     ██║██╔══██╗██╔══██╗██╔══██╗██╔══██╗╚██╗ ██╔╝
   696                                  ; ██║     ██║██████╔╝██████╔╝██║  ██║██████╔╝ ╚████╔╝ 
   697                                  ; ██║     ██║██╔══██╗██╔══██╗███████║██╔══██╗  ╚██╔╝  
   698                                  ; ███████╗██║██████╔╝██║  ██║██╔══██║██║  ██║   ██║   
   699                                  ; ╚══════╝╚═╝╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   
   700                                  ; //////////////////////////////////////////////////////////////////////////// ;
   701                                  
   702                                  ; 文字分類マクロ
   703                                  ; type.asm
   704                                  %include        "../asm/lib/type.asm"
     1                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
     2                              <1> ; type.asm
     3                              <1> ;       libIsalnum
     4                              <1> ;       libIsAlpha
     5                              <1> ;       libIsblank
     6                              <1> ;       libIscntrl
     7                              <1> ;       libIsdigit
     8                              <1> ;       libIsgraph
     9                              <1> ;       libIslower
    10                              <1> ;       libIsprint
    11                              <1> ;       libIspuct
    12                              <1> ;       libIsspace
    13                              <1> ;       libIsupper
    14                              <1> ;       libIsxdigit
    15                              <1> ;       libTolower
    16                              <1> ;       libToupper
    17                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
    18                              <1> 
    19                              <1> ; 英大文字か判定
    20                              <1> ; isupper(c89) 相当
    21                              <1> ; in  : AL      asciiコード
    22                              <1> ; out : AH      0: 大文字以外
    23                              <1> ;               0以外: 大文字
    24                              <1> libIsupper:
    25 0000050B 3C41                <1>         CMP     AL, 0x41                ; A
    26 0000050D 7208                <1>         JB      .ng                     ; AL < 'A' ならNG
    27 0000050F 3C5A                <1>         CMP     AL, 0x5a                ; Z
    28 00000511 7704                <1>         JA      .ng                     ; AL > 'Z' ならNG
    29                              <1> .ok:
    30 00000513 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
    31 00000515 EB04                <1>         JMP     .exit
    32                              <1> .ng:
    33 00000517 B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
    34 00000519 EB00                <1>         JMP     .exit
    35                              <1> .exit:
    36 0000051B C3                  <1>         RET
    37                              <1> 
    38                              <1> ; 英小文字か判定
    39                              <1> ; isupper(c89) 相当
    40                              <1> ; in  : AL      asciiコード
    41                              <1> ; out : AH      0: 小文字以外
    42                              <1> ;               0以外: 小文字
    43                              <1> libIslower:
    44 0000051C 3C61                <1>         CMP     AL, 0x61                ; a
    45 0000051E 7208                <1>         JB      .ng                     ; AL < 'a' ならNG
    46 00000520 3C7A                <1>         CMP     AL, 0x7a                ; z
    47 00000522 7704                <1>         JA      .ng                     ; AL > 'z' ならNG
    48                              <1> .ok:
    49 00000524 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
    50 00000526 EB04                <1>         JMP     .exit
    51                              <1> .ng:
    52 00000528 B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
    53 0000052A EB00                <1>         JMP     .exit
    54                              <1> .exit:
    55 0000052C C3                  <1>         RET
    56                              <1> 
    57                              <1> ; 数字か判定
    58                              <1> ; isdigit(c89) 相当
    59                              <1> ; in  : AL      asciiコード
    60                              <1> ; out : AH      0: 小文字以外
    61                              <1> ;               0以外: 小文字
    62                              <1> libIsdigit:
    63 0000052D 3C30                <1>         CMP     AL, 0x30                ; 0
    64 0000052F 7208                <1>         JB      .ng                     ; AL < '0' ならNG
    65 00000531 3C39                <1>         CMP     AL, 0x39                ; 9
    66 00000533 7704                <1>         JA      .ng                     ; AL > '9' ならNG
    67                              <1> .ok:
    68 00000535 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
    69 00000537 EB04                <1>         JMP     .exit
    70                              <1> .ng:
    71 00000539 B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
    72 0000053B EB00                <1>         JMP     .exit
    73                              <1> .exit:
    74 0000053D C3                  <1>         RET
    75                              <1> 
    76                              <1> ; 空白文字を含む表示文字か判定
    77                              <1> ; isprint(c89) 相当
    78                              <1> ; in  : AL      asciiコード
    79                              <1> ; out : AH      0: 表示文字以外
    80                              <1> ;               0以外: 表示文字
    81                              <1> libIsprint:
    82 0000053E 3C20                <1>         CMP     AL, 0x20
    83 00000540 7208                <1>         JB      .ng                     ; AL < 0x20 ならNG
    84 00000542 3C7E                <1>         CMP     AL, 0x7e
    85 00000544 7704                <1>         JA      .ng                     ; AL > 0x7e ならNG
    86                              <1> .ok:
    87 00000546 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
    88 00000548 EB04                <1>         JMP     .exit
    89                              <1> .ng:
    90 0000054A B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
    91 0000054C EB00                <1>         JMP     .exit
    92                              <1> .exit:
    93 0000054E C3                  <1>         RET
    94                              <1> 
    95                              <1> ; 空白文字を除く表示文字か判定
    96                              <1> ; isprint(c89) 相当
    97                              <1> ; in  : AL      asciiコード
    98                              <1> ; out : AH      0: 表示文字以外
    99                              <1> ;               0以外: 表示文字
   100                              <1> libIsgraph:
   101 0000054F 3C21                <1>         CMP     AL, 0x21
   102 00000551 7208                <1>         JB      .ng                     ; AL < 0x21 ならNG
   103 00000553 3C7E                <1>         CMP     AL, 0x7e
   104 00000555 7704                <1>         JA      .ng                     ; AL > 0x7e ならNG
   105                              <1> .ok:
   106 00000557 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   107 00000559 EB04                <1>         JMP     .exit
   108                              <1> .ng:
   109 0000055B B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   110 0000055D EB00                <1>         JMP     .exit
   111                              <1> .exit:
   112 0000055F C3                  <1>         RET
   113                              <1> 
   114                              <1> ; ブランク文字か判定
   115                              <1> ; isblank(c89) 相当
   116                              <1> ; in  : AL      asciiコード
   117                              <1> ; out : AH      0: ブランク文字以外
   118                              <1> ;               0以外: ブランク文字
   119                              <1> libIsblank:
   120 00000560 3C20                <1>         CMP     AL, 0x20                ; ' 'ならOK
   121 00000562 7406                <1>         JZ      .ok
   122 00000564 3C09                <1>         CMP     AL, 0x09
   123 00000566 7402                <1>         JZ      .ok                     ; '\t'ならOK
   124 00000568 EB04                <1>         JMP     .ng
   125                              <1> .ok:
   126 0000056A B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   127 0000056C EB04                <1>         JMP     .exit
   128                              <1> .ng:
   129 0000056E B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   130 00000570 EB00                <1>         JMP     .exit
   131                              <1> .exit:
   132 00000572 C3                  <1>         RET
   133                              <1> 
   134                              <1> ; 空白類文字か判定
   135                              <1> ; isspace(c89) 相当
   136                              <1> ; in  : AL      asciiコード
   137                              <1> ; out : AH      0: 空白類文字以外
   138                              <1> ;               0以外: 空白類文字
   139                              <1> libIsspace:
   140 00000573 3C09                <1>         CMP     AL, 0x09
   141 00000575 7416                <1>         JZ      .ok                     ; '\t'ならOK
   142 00000577 3C0A                <1>         CMP     AL, 0x0a
   143 00000579 7412                <1>         JZ      .ok                     ; '\n'ならOK
   144 0000057B 3C0B                <1>         CMP     AL, 0x0b
   145 0000057D 740E                <1>         JZ      .ok                     ; '\v'ならOK
   146 0000057F 3C0C                <1>         CMP     AL, 0x0c
   147 00000581 740A                <1>         JZ      .ok                     ; '\f'ならOK
   148 00000583 3C0D                <1>         CMP     AL, 0x0d
   149 00000585 7406                <1>         JZ      .ok                     ; '\r'ならOK
   150 00000587 3C20                <1>         CMP     AL, 0x20
   151 00000589 7402                <1>         JZ      .ok                     ; ' 'ならOK
   152 0000058B EB04                <1>         JMP     .ng
   153                              <1> .ok:
   154 0000058D B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   155 0000058F EB04                <1>         JMP     .exit
   156                              <1> .ng:
   157 00000591 B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   158 00000593 EB00                <1>         JMP     .exit
   159                              <1> .exit:
   160 00000595 C3                  <1>         RET
   161                              <1> 
   162                              <1> ; 制御文字か判定
   163                              <1> ; iscntrl(c89) 相当
   164                              <1> ; in  : AL      asciiコード
   165                              <1> ; out : AH      0: 制御文字以外
   166                              <1> ;               0以外: 制御文字
   167                              <1> libIscntrl:
   168 00000596 3C7F                <1>         CMP     AL, 0x7f
   169 00000598 7408                <1>         JZ      .ok                     ; '\del'ならOK
   170 0000059A 3C00                <1>         CMP     AL, 0x00
   171 0000059C 7208                <1>         JB      .ng                     ; AL < 0x00 ならNG
   172 0000059E 3C1F                <1>         CMP     AL, 0x1f
   173 000005A0 7704                <1>         JA      .ng                     ; AL > 0x1f ならNG
   174                              <1> .ok:
   175 000005A2 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   176 000005A4 EB04                <1>         JMP     .exit
   177                              <1> .ng:
   178 000005A6 B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   179 000005A8 EB00                <1>         JMP     .exit
   180                              <1> .exit:
   181 000005AA C3                  <1>         RET 
   182                              <1> 
   183                              <1> ; 16進数字か判定
   184                              <1> ; isxdigit(c89) 相当
   185                              <1> ; in  : AL      asciiコード
   186                              <1> ; out : AH      0: 16進文字以外
   187                              <1> ;               0以外: 16進文字
   188                              <1> libIsxdigit:
   189 000005AB 3C30                <1>         CMP     AL, 0x30                ; 0
   190 000005AD 7206                <1>         JB      .next1                  ; AL < '0' ならNG
   191 000005AF 3C39                <1>         CMP     AL, 0x39                ; 9
   192 000005B1 7702                <1>         JA      .next1                  ; AL > '9' ならNG
   193 000005B3 EB14                <1>         JMP     .ok
   194                              <1> .next1:
   195 000005B5 3C41                <1>         CMP     AL, 0x41                ; A
   196 000005B7 7206                <1>         JB      .next2                  ; AL < 'A' ならNG
   197 000005B9 3C46                <1>         CMP     AL, 0x46                ; F
   198 000005BB 7702                <1>         JA      .next2                  ; AL > 'F' ならNG
   199 000005BD EB0A                <1>         JMP     .ok
   200                              <1> .next2:
   201 000005BF 3C61                <1>         CMP     AL, 0x61                ; a
   202 000005C1 720A                <1>         JB      .ng                     ; AL < 'a' ならNG
   203 000005C3 3C66                <1>         CMP     AL, 0x66                ; f
   204 000005C5 7706                <1>         JA      .ng                     ; AL > 'f' ならNG
   205 000005C7 EB00                <1>         JMP     .ok
   206                              <1> .ok:
   207 000005C9 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   208 000005CB EB04                <1>         JMP     .exit
   209                              <1> .ng:
   210 000005CD B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   211 000005CF EB00                <1>         JMP     .exit
   212                              <1> .exit:
   213 000005D1 C3                  <1>         RET 
   214                              <1> 
   215                              <1> ; 英文字か判定
   216                              <1> ; isalpha(c89) 相当
   217                              <1> ; in  : AL      asciiコード
   218                              <1> ; out : AH      0: 英文字以外
   219                              <1> ;               0以外: 英文字
   220                              <1> libIsalpha:
   221 000005D2 E836FF              <1>         CALL    libIsupper              ; 大文字か確認
   222 000005D5 80FC00              <1>         CMP     AH, 0x00
   223 000005D8 750A                <1>         JNZ     .ok
   224 000005DA E83FFF              <1>         CALL    libIslower              ; 小文字か確認
   225 000005DD 80FC00              <1>         CMP     AH, 0x00
   226 000005E0 7502                <1>         JNZ     .ok
   227 000005E2 EB04                <1>         JMP     .ng
   228                              <1> .ok:
   229 000005E4 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   230 000005E6 EB04                <1>         JMP     .exit
   231                              <1> .ng:
   232 000005E8 B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   233 000005EA EB00                <1>         JMP     .exit
   234                              <1> .exit:
   235 000005EC C3                  <1>         RET 
   236                              <1> 
   237                              <1> ; 英文字or数字か判定
   238                              <1> ; isalnum(c89) 相当
   239                              <1> ; in  : AL      asciiコード
   240                              <1> ; out : AH      0: 英文字でも数字でもない
   241                              <1> ;               0以外: 英文字or数字
   242                              <1> libIsalnum:
   243 000005ED E81BFF              <1>         CALL    libIsupper              ; 大文字か確認
   244 000005F0 80FC00              <1>         CMP     AH, 0x00
   245 000005F3 7512                <1>         JNZ     .ok
   246 000005F5 E824FF              <1>         CALL    libIslower              ; 小文字か確認
   247 000005F8 80FC00              <1>         CMP     AH, 0x00
   248 000005FB 750A                <1>         JNZ     .ok
   249 000005FD E82DFF              <1>         CALL    libIsdigit              ; 数字か確認
   250 00000600 80FC00              <1>         CMP     AH, 0x00
   251 00000603 7502                <1>         JNZ     .ok
   252 00000605 EB04                <1>         JMP     .ng
   253                              <1> .ok:
   254 00000607 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   255 00000609 EB04                <1>         JMP     .exit
   256                              <1> .ng:
   257 0000060B B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   258 0000060D EB00                <1>         JMP     .exit
   259                              <1> .exit:
   260 0000060F C3                  <1>         RET 
   261                              <1> 
   262                              <1> ; 区切り文字か判定(区切り文字 = (!(isalnum) & isgraph)
   263                              <1> ; ispunct(c89) 相当
   264                              <1> ; in  : AL      asciiコード
   265                              <1> ; out : AH      0: 区切り文字以外
   266                              <1> ;               0以外: 区切り文字
   267                              <1> libIspunct:
   268 00000610 E8DAFF              <1>         CALL    libIsalnum              ; 英文字or数字か確認
   269 00000613 80FC00              <1>         CMP     AH, 0x00
   270 00000616 750E                <1>         JNZ     .ng                     ; 英文字or数字ならNG
   271 00000618 E834FF              <1>         CALL    libIsgraph              ; 空白を除く印字可能文字か確認
   272 0000061B 80FC00              <1>         CMP     AH, 0x00
   273 0000061E 7502                <1>         JNZ     .ok                     ; 印字可能文字ならOK
   274 00000620 EB04                <1>         JMP     .ng
   275                              <1> .ok:
   276 00000622 B401                <1>         MOV     AH, 0x01                ; OKなら 1 を返却
   277 00000624 EB04                <1>         JMP     .exit
   278                              <1> .ng:
   279 00000626 B400                <1>         MOV     AH, 0x00                ; NGなら 0 を返却
   280 00000628 EB00                <1>         JMP     .exit
   281                              <1> .exit:
   282 0000062A C3                  <1>         RET
   283                              <1> 
   284                              <1> ; 大文字を小文字に変換
   285                              <1> ; tolower(c89) 相当
   286                              <1> ; in  : AL      asciiコード
   287                              <1> ; out : AH      変換後asciiコード
   288                              <1> libTolower:
   289 0000062B E8DDFE              <1>         CALL    libIsupper              ; 大文字か判定
   290 0000062E 80FC00              <1>         CMP     AH, 0x00
   291 00000631 7402                <1>         JZ      .exit                   ; 大文字ではないなら変換しない
   292 00000633 0420                <1>         ADD     AL, 0x20
   293                              <1> .exit:
   294 00000635 88C4                <1>         MOV     AH, AL
   295 00000637 C3                  <1>         RET
   296                              <1> 
   297                              <1> ; 小文字を大文字に変換
   298                              <1> ; toupper(c89) 相当
   299                              <1> ; in  : AL      asciiコード
   300                              <1> ; out : AH      変換後asciiコード
   301                              <1> libToupper:
   302 00000638 E8E1FE              <1>         CALL    libIslower              ; 小文字か判定
   303 0000063B 80FC00              <1>         CMP     AH, 0x00
   304 0000063E 7402                <1>         JZ      .exit                   ; 小文字ではないなら変換しない
   305 00000640 2C20                <1>         SUB     AL, 0x20
   306                              <1> .exit:
   307 00000642 88C4                <1>         MOV     AH, AL
   308 00000644 C3                  <1>         RET
   705                                  
   706                                  ; 画面カーソル制御マクロ
   707                                  ; cursol.asm
   708                                  %include        "../asm/lib/cursol.asm"
     1                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
     2                              <1> ; cursol.asm
     3                              <1> ;       libSetCursol
     4                              <1> ;       libSlideDisp
     5                              <1> ;       libSetCursolNextCol
     6                              <1> ;       libSetCursolNextLine
     7                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
     8                              <1> 
     9                              <1> ; カーソル表示更新
    10                              <1> ; in  : (なし)
    11                              <1> ; out : (なし)
    12                              <1> libSetCursol:
    13 00000645 E83703              <1>         CALL    rPushReg                ; レジスタ退避
    14                              <1> 
    15 00000648 B402                <1>         MOV     AH, 0x02
    16 0000064A B700                <1>         MOV     BH, 0x00
    17 0000064C 8A16[E900]          <1>         MOV BYTE DL, [sXpos]
    18 00000650 8A36[EA00]          <1>         MOV BYTE DH, [sYpos]
    19 00000654 CD10                <1>         INT     0x10
    20                              <1> 
    21 00000656 E84303              <1>         CALL    rPopReg                 ; レジスタ取得
    22 00000659 C3                  <1>         RET
    23                              <1> 
    24                              <1> ; 画面表示を1行上に移動
    25                              <1> ; in  : (なし)
    26                              <1> ; out : (なし)
    27                              <1> libSlideDisp:
    28 0000065A E82203              <1>         CALL    rPushReg                ; レジスタ退避
    29                              <1> 
    30 0000065D B406                <1>         MOV     AH, 0x06
    31 0000065F B001                <1>         MOV     AL, 0x01
    32 00000661 B707                <1>         MOV     BH, 0x07
    33 00000663 B90000              <1>         MOV     CX, 0x0000
    34 00000666 B618                <1>         MOV     DH, 24
    35 00000668 B24F                <1>         MOV     DL, 79
    36 0000066A CD10                <1>         INT     0x10
    37                              <1> 
    38 0000066C E82D03              <1>         CALL    rPopReg                 ; レジスタ取得
    39 0000066F C3                  <1>         RET
    40                              <1> 
    41                              <1> ; カーソルを次の列へ
    42                              <1> ; in  : (なし)
    43                              <1> ; out : (なし)
    44                              <1> libSetCursolNextCol:
    45 00000670 E80C03              <1>         CALL    rPushReg                ; レジスタ退避
    46                              <1> 
    47 00000673 8A26[E900]          <1>         MOV BYTE AH, [sXpos]            ; 取得
    48 00000677 A0[EA00]            <1>         MOV BYTE AL, [sYpos]
    49                              <1> 
    50 0000067A 80FC4F              <1>         CMP     AH, DISP_COLSIZE
    51 0000067D 740E                <1>         JZ      .newLine
    52                              <1> 
    53 0000067F FEC4                <1>         INC     AH
    54 00000681 8826[E900]          <1>         MOV BYTE [sXpos], AH            ; 設定
    55 00000685 A2[EA00]            <1>         MOV BYTE [sYpos], AL
    56 00000688 E8EF01              <1>         CALL    rSetCursol              ; カーソル表示更新
    57 0000068B EB03                <1>         JMP     .next
    58                              <1> .newLine:
    59 0000068D E80400              <1>         CALL    libSetCursolNextLine
    60                              <1> .next:
    61 00000690 E80903              <1>         CALL    rPopReg                 ; レジスタ取得
    62 00000693 C3                  <1>         RET
    63                              <1> 
    64                              <1> ; カーソルを次の行へ
    65                              <1> ; in  : (なし)
    66                              <1> ; out : (なし)
    67                              <1> libSetCursolNextLine:
    68 00000694 E8E802              <1>         CALL    rPushReg                ; レジスタ退避
    69                              <1> 
    70 00000697 8A26[E900]          <1>         MOV BYTE AH, [sXpos]            ; 取得
    71 0000069B A0[EA00]            <1>         MOV BYTE AL, [sYpos]
    72                              <1> 
    73 0000069E 3C18                <1>         CMP     AL, DISP_LINESIZE
    74 000006A0 7507                <1>         JNZ     .nextLine               ; 一番下じゃないなら普通の改行
    75 000006A2 80FC4F              <1>         CMP     AH, DISP_COLSIZE
    76 000006A5 750F                <1>         JNZ     .slideLine              ; 一番右じゃないならスクロール(79列目に出力するとBIOS側でスクロールする)
    77 000006A7 EB10                <1>         JMP     .nonSlide
    78                              <1> .nextLine:
    79 000006A9 B400                <1>         MOV     AH, 0x00
    80 000006AB FEC0                <1>         INC     AL
    81                              <1> 
    82 000006AD 8826[E900]          <1>         MOV BYTE [sXpos], AH            ; 設定
    83 000006B1 A2[EA00]            <1>         MOV BYTE [sYpos], AL
    84 000006B4 EB0D                <1>         JMP     .setCursol
    85                              <1> .slideLine:
    86 000006B6 E8A1FF              <1>         CALL    libSlideDisp
    87                              <1> .nonSlide:
    88 000006B9 C606[E900]00        <1>         MOV BYTE [sXpos], 0x00          ; 設定
    89 000006BE C606[EA00]18        <1>         MOV BYTE [sYpos], DISP_LINESIZE
    90                              <1> .setCursol:                             ; カーソル位置更新
    91 000006C3 E8B401              <1>         CALL    rSetCursol
    92                              <1> 
    93 000006C6 E8D302              <1>         CALL    rPopReg                 ; レジスタ取得
    94 000006C9 C3                  <1>         RET
   709                                  
   710                                  ; 配列操作マクロ
   711                                  ; array.asm
   712                                  %include        "../asm/lib/array.asm"
     1                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
     2                              <1> ; array.h
     3                              <1> ;       libMemcpy
     4                              <1> ;       libMemcmp
     5                              <1> ;       libMemchr
     6                              <1> ;       libMemset
     7                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
     8                              <1> 
     9                              <1> ; メモリのコピー
    10                              <1> ; memcpy(c89相当)
    11                              <1> ; in  : SI      コピー元のアドレス
    12                              <1> ;       CX      コピーするサイズ
    13                              <1> ; out : DI      コピー先のアドレス
    14                              <1> libMemcpy:
    15 000006CA E8B202              <1>         CALL    rPushReg                ; レジスタ退避
    16                              <1> 
    17 000006CD 83F900              <1>         CMP     CX, 0x0000              ; サイズチェック
    18 000006D0 740C                <1>         JZ      .exit
    19                              <1> 
    20                              <1> .fillLoop:
    21 000006D2 8A24                <1>         MOV BYTE AH, [SI]
    22 000006D4 8825                <1>         MOV BYTE [DI], AH
    23 000006D6 46                  <1>         INC     SI
    24 000006D7 47                  <1>         INC     DI
    25 000006D8 49                  <1>         DEC     CX
    26                              <1>         
    27 000006D9 83F900              <1>         CMP     CX, 0x0000
    28 000006DC 75F4                <1>         JNZ     .fillLoop
    29                              <1> 
    30                              <1> .exit:
    31 000006DE E8BB02              <1>         CALL    rPopReg                 ; レジスタ取得
    32 000006E1 C3                  <1>         RET
    33                              <1> 
    34                              <1> ; メモリの比較
    35                              <1> ; memcmp(c89相当)
    36                              <1> ; in  : SI      比較先頭アドレス１
    37                              <1> ;       DI      比較先頭アドレス２
    38                              <1> ;       CX      比較サイズ
    39                              <1> ; out : AX      0x0000: 一致
    40                              <1> ;               0x0001: アドレス１が大きい
    41                              <1> ;               0xffff: アドレス２が大きい
    42                              <1> libMemcmp:
    43 000006E2 E89A02              <1>         CALL    rPushReg
    44 000006E5 C706[2507]0000      <1>         MOV WORD [.aRet], 0x0000
    45                              <1> 
    46 000006EB 83F900              <1>         CMP     CX, 0x0000
    47 000006EE 742E                <1>         JZ      .exit
    48                              <1> 
    49 000006F0 B80000              <1>         MOV     AX, 0x0000
    50                              <1> 
    51                              <1> .cmpLoop:
    52 000006F3 01C6                <1>         ADD     SI, AX                  ; オフセット追加
    53 000006F5 01C7                <1>         ADD     DI, AX
    54                              <1> 
    55 000006F7 8A3C                <1>         MOV BYTE BH, [SI]               ; [SI+AX]
    56 000006F9 8A1D                <1>         MOV BYTE BL, [DI]
    57                              <1> 
    58 000006FB 29C6                <1>         SUB     SI, AX                  ; オフセットリセット
    59 000006FD 29C7                <1>         SUB     DI, AX
    60                              <1> 
    61 000006FF 38DF                <1>         CMP     BH, BL
    62 00000701 770B                <1>         JA      .upper                  ; BH > BLなら0x0001を返却
    63 00000703 38DF                <1>         CMP     BH, BL
    64 00000705 720F                <1>         JB      .lower                  ; BH < BLなら0xffffを返却
    65                              <1>         
    66 00000707 40                  <1>         INC     AX
    67 00000708 39C8                <1>         CMP     AX, CX
    68 0000070A 7412                <1>         JZ      .exit
    69 0000070C EBE5                <1>         JMP     .cmpLoop
    70                              <1> 
    71                              <1> .upper:
    72 0000070E C706[2507]0100      <1>         MOV WORD [.aRet], 0x0001
    73 00000714 EB08                <1>         JMP     .exit
    74                              <1> .lower:
    75 00000716 C706[2507]FFFF      <1>         MOV WORD [.aRet], 0xffff
    76 0000071C EB00                <1>         JMP     .exit
    77                              <1> .exit:
    78 0000071E E87B02              <1>         CALL    rPopReg
    79 00000721 A1[2507]            <1>         MOV WORD AX, [.aRet]
    80 00000724 C3                  <1>         RET
    81                              <1> .aRet:
    82 00000725 0000                <1>         DW      0x0000
    83                              <1> 
    84                              <1> ; メモリの探索
    85                              <1> ; memchr(c89相当)
    86                              <1> ; in  : SI      探索する先頭アドレス
    87                              <1> ;       AH      ヒットするバイトデータ
    88                              <1> ;       CX      探索する文字数
    89                              <1> ; out : DI      0x0000: 一致データなし
    90                              <1> ;               0x0000以外: 最初に一致したアドレス
    91                              <1> libMemchr:
    92 00000727 E85502              <1>         CALL    rPushReg
    93 0000072A E86F02              <1>         CALL    rPopReg
    94 0000072D C3                  <1>         RET
    95                              <1> 
    96                              <1> ; メモリの初期化
    97                              <1> ; memset(c89相当)
    98                              <1> ; in  : SI      初期化先頭アドレス
    99                              <1> ;       AH      埋めるデータ
   100                              <1> ;       CX      埋めるデータサイズ
   101                              <1> libMemset:
   102 0000072E E84E02              <1>         CALL    rPushReg
   103 00000731 E86802              <1>         CALL    rPopReg
   104 00000734 C3                  <1>         RET
   713                                  
   714                                  ; 型変換マクロ
   715                                  ; cast.asm
   716                                  %include        "../asm/lib/cast.asm"
     1                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
     2                              <1> ; cast.h                                                                       ;
     3                              <1> ; //////////////////////////////////////////////////////////////////////////// ;
     4                              <1> 
     5                              <1> ; 2バイト変数を16進文字列へ変換
     6                              <1> ; in  : AX      変換元の2バイト即値
     7                              <1> ; i/o   SI      変換結果を格納する先頭アドレス
     8                              <1> libitox:
     9 00000735 E84702              <1>         CALL    rPushReg
    10                              <1> 
    11 00000738 A3[7D07]            <1>         MOV WORD [.aInput], AX
    12 0000073B 8936[7F07]          <1>         MOV WORD [.aRet], SI
    13                              <1> 
    14                              <1>         ; debug
    15                              <1>         ;MOV BYTE [SI], "1"
    16                              <1>         ;INC     SI
    17                              <1>         ;MOV BYTE [SI], "2"
    18                              <1>         ;INC     SI
    19                              <1>         ;MOV BYTE [SI], "3"
    20                              <1>         ;INC     SI
    21                              <1>         ;MOV BYTE [SI], "4"
    22                              <1>         ;JMP     .exit
    23                              <1> 
    24                              <1>         ; 1文字目
    25 0000073F A1[7D07]            <1>         MOV     AX, [.aInput]
    26 00000742 2500F0              <1>         AND     AX, 0xf000
    27 00000745 C0EC04              <1>         SHR     AH, 4
    28 00000748 E83600              <1>         CALL    ritox1digit
    29 0000074B 8804                <1>         MOV BYTE [SI], AL
    30 0000074D 46                  <1>         INC     SI
    31                              <1> 
    32                              <1>         ; 2文字目
    33 0000074E A1[7D07]            <1>         MOV     AX, [.aInput]
    34 00000751 25000F              <1>         AND     AX, 0x0f00
    35 00000754 E82A00              <1>         CALL    ritox1digit
    36 00000757 8804                <1>         MOV BYTE [SI], AL
    37 00000759 46                  <1>         INC     SI
    38                              <1> 
    39                              <1>         ; 3文字目
    40 0000075A A1[7D07]            <1>         MOV     AX, [.aInput]
    41 0000075D 25F000              <1>         AND     AX, 0x00f0
    42 00000760 88C4                <1>         MOV     AH, AL
    43 00000762 C0EC04              <1>         SHR     AH, 4
    44 00000765 E81900              <1>         CALL    ritox1digit
    45 00000768 8804                <1>         MOV BYTE [SI], AL
    46 0000076A 46                  <1>         INC     SI
    47                              <1> 
    48                              <1>         ; 4文字目
    49 0000076B A1[7D07]            <1>         MOV     AX, [.aInput]
    50 0000076E 83E00F              <1>         AND     AX, 0x000f
    51 00000771 88C4                <1>         MOV     AH, AL
    52 00000773 E80B00              <1>         CALL    ritox1digit
    53 00000776 8804                <1>         MOV BYTE [SI], AL
    54 00000778 46                  <1>         INC     SI
    55                              <1> 
    56                              <1> .exit:
    57 00000779 E82002              <1>         CALL    rPopReg
    58 0000077C C3                  <1>         RET
    59                              <1> .aInput:
    60 0000077D 0000                <1>         DW      0x0000
    61                              <1> .aRet:
    62 0000077F 0000                <1>         DW      0x0000
    63                              <1> 
    64                              <1> ; ファイル内サブルーチン
    65                              <1> 
    66                              <1> ; 16進数値 → 16進文字 (1文字)
    67                              <1> ; in  : AH      16進数値(0x00 ~ 0x0f)
    68                              <1> ; out : AL      16進文字('0' ~ 'f')
    69                              <1> ritox1digit:
    70 00000781 E8FB01              <1>         CALL    rPushReg
    71                              <1> 
    72 00000784 80E40F              <1>         AND     AH, 0x0f                    ; 上4ビットを無効化
    73 00000787 80FC09              <1>         CMP     AH, 0x09
    74 0000078A 770B                <1>         JA      .transaf
    75                              <1> .trans09:                                   ; 0~9
    76 0000078C 8826[AE07]          <1>         MOV BYTE [.aRet], AH
    77 00000790 8006[AE07]30        <1>         ADD BYTE [.aRet], 0x30              ; "0"
    78 00000795 EB10                <1>         JMP     .exit
    79                              <1> .transaf:
    80 00000797 8826[AE07]          <1>         MOV BYTE [.aRet], AH                ; a~f
    81 0000079B 802E[AE07]0A        <1>         SUB BYTE [.aRet], 10
    82 000007A0 8006[AE07]41        <1>         ADD BYTE [.aRet], 0x41              ; A
    83 000007A5 EB00                <1>         JMP     .exit
    84                              <1> 
    85                              <1> .exit:
    86 000007A7 E8F201              <1>         CALL    rPopReg
    87                              <1> 
    88 000007AA A0[AE07]            <1>         MOV BYTE AL, [.aRet]                 ; 戻り値設定
    89 000007AD C3                  <1>         RET
    90                              <1> .aRet:
    91 000007AE 00                  <1>         DB      0x00
   717                                  
   718                                  ; //////////////////////////////////////////////////////////////////////////// ;
   719                                  ; stdio.h                                                                      ;
   720                                  ;       libPutchar      libPuts         libsParse       libsPrintf             ;
   721                                  ; //////////////////////////////////////////////////////////////////////////// ;
   722                                  
   723                                  ; 1文字出力
   724                                  ; static変数の座標を参照する
   725                                  ; putchar(c89) 相当
   726                                  ; in  : AL      asciiコード
   727                                  ; out : (なし)
   728                                  libPutchar:
   729 000007AF E8CD01                          CALL    rPushReg                ; レジスタ退避
   730                                  
   731 000007B2 A2[D307]                        MOV BYTE [.aChar], AL
   732                                  
   733 000007B5 B413                            MOV     AH, 0x13
   734 000007B7 B000                            MOV     AL, 0x00
   735 000007B9 B700                            MOV     BH, 0x00
   736 000007BB 8A1E[EB00]                      MOV BYTE BL, [sColorNormal]
   737 000007BF B90100                          MOV     CX, 0x0001
   738 000007C2 8A16[E900]                      MOV BYTE DL, [sXpos]
   739 000007C6 8A36[EA00]                      MOV BYTE DH, [sYpos]
   740 000007CA BD[D307]                        MOV     BP, .aChar
   741 000007CD CD10                            INT     0x10
   742                                  
   743 000007CF E8CA01                          CALL    rPopReg                 ; レジスタ取得
   744 000007D2 C3                              RET
   745                                  .aChar:                                 ; 表示文字
   746 000007D3 00                              DB      0x00
   747                                  
   748                                  ; 文字列出力(エスケープシーケンスなし)
   749                                  ; \0 (0x00) を確認し次第改行して終了
   750                                  ; puts(c89) 相当
   751                                  ; in  : DS:BP   表示する文字列ポインタ
   752                                  ; out : なし
   753                                  libPuts:
   754 000007D4 E8A801                          CALL    rPushReg                ; レジスタ退避
   755                                  
   756                                          ;MOV     AX, 0x0000
   757                                          ;MOV     SS, AX
   758                                  .chk:
   759                                          ; 1文字取得 ---->
   760 000007D7 8A4600                          MOV BYTE AL, [BP]
   761 000007DA 3C00                            CMP     AL, 0x00
   762 000007DC 740B                            JZ      .nextLine
   763 000007DE EB00                            JMP     .put
   764                                          ; <---- 1文字取得
   765                                  
   766                                  .put:
   767 000007E0 E8CCFF                          CALL    libPutchar
   768 000007E3 E88AFE                          CALL    libSetCursolNextCol
   769                                  
   770 000007E6 45                              INC     BP
   771 000007E7 EBEE                            JMP     .chk
   772                                  
   773                                          ; 改行
   774                                  .nextLine:
   775 000007E9 E8A8FE                          CALL    libSetCursolNextLine
   776                                  
   777 000007EC E8AD01                          CALL    rPopReg                 ; レジスタ取得
   778 000007EF C3                              RET
   779                                  
   780                                  ; 文字列出力(エスケープシーケンスあり)
   781                                  ; \0 (0x00) を確認し次第改行して終了
   782                                  ; '\'を確認し次第エスケープシーケンス確認
   783                                  ; puts(c89) 相当
   784                                  ; in  : SS:BP   表示する文字列ポインタ
   785                                  ; out : なし
   786                                  libsParse:
   787 000007F0 E88C01                          CALL    rPushReg                ; レジスタ退避   
   788                                  .chk:
   789                                          ; 1文字取得 ---->
   790 000007F3 8A4600                          MOV BYTE AL, [BP]
   791 000007F6 3C00                            CMP     AL, 0x00
   792 000007F8 7472                            JZ      .nextLine
   793 000007FA EB00                            JMP     .put
   794                                          ; <---- 1文字取得
   795                                  
   796                                  .put:
   797 000007FC 3C5C                            CMP     AL, "\"
   798 000007FE 7409                            JZ      .parse
   799                                  .print:
   800 00000800 E8ACFF                          CALL    libPutchar
   801 00000803 E86AFE                          CALL    libSetCursolNextCol
   802                                  
   803 00000806 45                              INC     BP
   804 00000807 EBEA                            JMP     .chk
   805                                  .parse:
   806 00000809 45                              INC     BP
   807 0000080A 8A4600                          MOV BYTE AL, [BP]            ; '\'の次の1文字を取得
   808                                  
   809                                          ; \b: バックスペース
   810                                  .bs:
   811 0000080D 3C62                            CMP     AL, "b"
   812 0000080F 7516                            JNZ     .tab
   813 00000811 8A26[E900]                      MOV BYTE AH, [sXpos]
   814 00000815 80FC00                          CMP     AH, 0x00
   815 00000818 7406                            JZ      .bsNext
   816 0000081A FECC                            DEC     AH
   817 0000081C 8826[E900]                      MOV BYTE [sXpos], AH
   818                                  .bsNext:
   819 00000820 B020                            MOV     AL, " "
   820 00000822 E88AFF                          CALL    libPutchar
   821                                  
   822 00000825 EB42                            JMP     .parseend
   823                                  
   824                                          ; \t: タブ
   825                                  .tab:
   826 00000827 3C74                            CMP     AL, "t"
   827 00000829 7518                            JNZ     .lf
   828                                  .tabLoop:
   829 0000082B 8A26[E900]                      MOV BYTE AH, [sXpos]
   830 0000082F 80E407                          AND     AH, 0x07
   831 00000832 80FC00                          CMP     AH, 0x00
   832 00000835 740A                            JZ      .tabNext
   833                                  
   834 00000837 B020                            MOV     AL, " "
   835 00000839 E873FF                          CALL    libPutchar
   836 0000083C E831FE                          CALL    libSetCursolNextCol
   837 0000083F EBEA                            JMP     .tabLoop
   838                                  .tabNext:
   839 00000841 EB26                            JMP     .parseend
   840                                  
   841                                          ; \n: 改行
   842                                  .lf:
   843 00000843 3C6E                            CMP     AL, "n"
   844 00000845 7505                            JNZ     .cr
   845 00000847 E84AFE                          CALL    libSetCursolNextLine
   846                                  
   847 0000084A EB1D                            JMP     .parseend
   848                                  
   849                                          ; \r: キャリッジリターン
   850                                  .cr:
   851 0000084C 3C72                            CMP     AL, "r"
   852 0000084E 7507                            JNZ     .bslash
   853 00000850 C606[E900]00                    MOV BYTE [sXpos], 0x00
   854 00000855 EB12                            JMP     .parseend
   855                                  
   856                                          ; \\: バックスラッシュ
   857                                  .bslash:
   858 00000857 3C5C                            CMP     AL, "\"
   859 00000859 750A                            JNZ     .null
   860                                  
   861 0000085B B05C                            MOV     AL, "\"
   862 0000085D E84FFF                          CALL    libPutchar
   863 00000860 E80DFE                          CALL    libSetCursolNextCol
   864                                  
   865 00000863 EB04                            JMP     .parseend
   866                                  
   867                                          ; 0x00: 出力中断
   868                                  .null:
   869 00000865 3C00                            CMP     AL, 0x00
   870 00000867 7503                            JNZ     .nextLine
   871                                  .parseend:
   872 00000869 45                              INC     BP
   873 0000086A EB87                            JMP     .chk
   874                                  
   875                                          ; 改行
   876                                  .nextLine:
   877 0000086C E825FE                          CALL    libSetCursolNextLine
   878 0000086F E82A01                          CALL    rPopReg                 ; レジスタ取得
   879 00000872 C3                              RET
   880                                  
   881                                  libsPrintf:
   882 00000873 E80901                          CALL    rPushReg                ; レジスタ退避
   883                                          
   884 00000876 E82301                          CALL    rPopReg                 ; レジスタ取得
   885 00000879 C3                              RET
   886                                  
   887                                  ; //////////////////////////////////////////////////////////////////////////// ;
   888                                  ; --- サブルーチン ---
   889                                  ;  ██████╗██╗   ██╗██████╗      ██████╗  ██████╗ ██╗   ██╗████████╗██╗███╗  ██╗███████╗
   890                                  ; ██╔════╝██║   ██║██╔══██╗     ██╔══██╗██╔═══██╗██║   ██║╚══██╔══╝██║████╗ ██║██╔════╝
   891                                  ; ╚█████╗ ██║   ██║██████╔╝     ██████╔╝██║   ██║██║   ██║   ██║   ██║██╔██╗██║███████╗
   892                                  ;  ╚═══██╗██║   ██║██╔══██╗     ██╔══██╗██║   ██║██║   ██║   ██║   ██║██║╚████║██╔════╝
   893                                  ; ██████╔╝╚██████╔╝██████╔╝     ██║  ██║╚██████╔╝╚██████╔╝   ██║   ██║██║ ╚███║███████╗
   894                                  ; ╚═════╝  ╚═════╝ ╚═════╝      ╚═╝  ╚═╝ ╚═════╝  ╚═════╝    ╚═╝   ╚═╝╚═╝  ╚══╝╚══════╝
   895                                  ; //////////////////////////////////////////////////////////////////////////// ;
   896                                  
   897                                  ; カーソル表示更新
   898                                  ; in  : (なし)
   899                                  ; out : (なし)
   900                                  rSetCursol:
   901 0000087A E80201                          CALL    rPushReg                ; レジスタ退避
   902                                  
   903 0000087D B402                            MOV     AH, 0x02
   904 0000087F B700                            MOV     BH, 0x00
   905 00000881 8A16[E900]                      MOV BYTE DL, [sXpos]
   906 00000885 8A36[EA00]                      MOV BYTE DH, [sYpos]
   907 00000889 CD10                            INT     0x10
   908                                  
   909 0000088B E80E01                          CALL    rPopReg                 ; レジスタ取得
   910 0000088E C3                              RET
   911                                  
   912                                  ; シェル入力をディスプレイとバッファに格納する
   913                                  ; in  : (なし)
   914                                  ; out : AH      0: 続ける
   915                                  ;               1: 終了(enterキー)
   916                                  ;               2: バッファオーバーフロー
   917                                  rOneLineInput:
   918 0000088F E8ED00                          CALL    rPushReg                ; レジスタ退避
   919 00000892 C606[E608]00                    MOV BYTE [.aChar], 0x00         ; 戻り値設定
   920                                  
   921                                          ; 入力から1文字取得 ---->
   922 00000897 B400                            MOV     AH, 0x00                ; 1文字取得
   923 00000899 CD16                            INT     0x16
   924                                          ; <---- 入力から1文字取得
   925                                  
   926                                          ; 印字可能文字の判定 ---->
   927 0000089B 3C0D                            CMP     AL, 0x0d                ; enterで終了
   928 0000089D 7410                            JZ      .caseEnter
   929 0000089F E89CFC                          CALL    libIsprint              ; 印字可能文字か判定
   930 000008A2 80FC00                          CMP     AH, 0x00
   931 000008A5 7412                            JZ      .caseNotEnter
   932                                          ; <---- 印字可能文字の判定
   933                                  
   934                                          ; 画面への反映 ---->
   935 000008A7 A2[E608]                        MOV BYTE [.aChar], AL
   936 000008AA E802FF                          CALL    libPutchar              ; 1文字出力
   937 000008AD EB0A                            JMP     .caseNotEnter
   938                                          ; <---- 画面への反映
   939                                  
   940                                          ; カーソル位置更新 ---->
   941                                  .caseEnter:                             ; enterを入力した場合
   942 000008AF E8E2FD                          CALL    libSetCursolNextLine    ; 改行用のカーソル移動
   943 000008B2 C606[E708]01                    MOV BYTE [.aRet], 0x01         ; 戻り値設定
   944 000008B7 EB25                            JMP     .exitLoutine            ; 格納せず終了
   945                                  .caseNotEnter:                          ; enter以外を入力した場合
   946 000008B9 E8B4FD                          CALL    libSetCursolNextCol     ; 通常用のカーソル移動
   947 000008BC C606[E708]00                    MOV BYTE [.aRet], 0x00         ; 戻り値設定
   948 000008C1 EB00                            JMP     .setBuf                 ; バッファに格納
   949                                          ; <---- カーソル位置更新
   950                                  .setBuf:                                ; バッファに文字を格納する
   951                                          ; debug ---->
   952                                          ;JMP     .exitLoutine
   953                                          ; <---- debug
   954                                  
   955                                          ; バッファに格納 ---->
   956 000008C3 B8[F000]                        MOV     AX, sOneLineBuf
   957 000008C6 0306[F001]                      ADD WORD AX, [sOneLineSeek]     ; 配列のオフセット
   958 000008CA 89C5                            MOV     BP, AX
   959 000008CC 8A26[E608]                      MOV BYTE AH, [.aChar]
   960 000008D0 886600                          MOV BYTE [BP], AH            ; 格納
   961                                          ; <---- バッファに格納
   962                                  
   963                                          ; オフセットシーク ---->
   964 000008D3 8B0E[F001]                      MOV WORD CX, [sOneLineSeek]
   965 000008D7 41                              INC     CX
   966 000008D8 890E[F001]                      MOV WORD [sOneLineSeek], CX
   967                                          ; <---- オフセットシーク
   968                                          
   969 000008DC EB00                            JMP     .exitLoutine
   970                                  .exitLoutine:
   971 000008DE E8BB00                          CALL    rPopReg                 ; レジスタ取得
   972 000008E1 8A26[E708]                      MOV BYTE AH, [.aRet]
   973 000008E5 C3                              RET
   974                                  .aChar:                                 ; 取得文字
   975 000008E6 00                              DB      0x00
   976                                  .aRet:                                  ; 戻り値
   977 000008E7 00                              DB      0x00
   978                                  
   979                                  ; 入力バッファをクリアする
   980                                  ; in  : (なし)
   981                                  ; out : (なし)
   982                                  rOneLineClear:
   983 000008E8 E89400                          CALL    rPushReg                ; レジスタ退避
   984                                  
   985 000008EB BF[F000]                        MOV WORD DI, sOneLineBuf
   986 000008EE B90000                          MOV     CX, 0x0000
   987                                  .clearLoop:                             ; 0埋め
   988 000008F1 C60500                          MOV BYTE [DI], 0x00
   989 000008F4 41                              INC     CX
   990 000008F5 47                              INC     DI
   991 000008F6 81F90001                        CMP     CX, 0x0100
   992 000008FA 75F5                            JNZ     .clearLoop
   993                                  
   994 000008FC C706[F001]0000                  MOV WORD [sOneLineSeek], 0x0000 ; バッファシークリセット
   995                                          ;MOV WORD DI, [sOneLineBuf]
   996                                  
   997 00000902 E89700                          CALL    rPopReg                 ; レジスタ取得
   998 00000905 C3                              RET
   999                                  
  1000                                  ; malloc 用のアロケーションメモリとアロケーションテーブルを初期化
  1001                                  ; アロケーションメモリ 0x0800 ~ 0x0fff
  1002                                  ; アロケーションテーブル 0x8000 ~ 0xffff
  1003                                  ; in  : なし
  1004                                  ; out : なし
  1005                                  rInitMalloc:
  1006 00000906 E87600                          CALL    rPushReg                ; レジスタ退避
  1007                                  
  1008 00000909 BD0008                          MOV     BP, 0x0800
  1009                                  .initLoop:
  1010 0000090C C6460000                        MOV BYTE [BP], 0x00
  1011 00000910 45                              INC     BP
  1012 00000911 81FD0010                        CMP     BP, 0x1000
  1013 00000915 75F5                            JNZ     .initLoop
  1014                                  
  1015 00000917 8EC0                            MOV     ES, AX
  1016                                  %ifdef __DEBUG
  1017                                          ;MOV     CX, 0x0012              ; 動的確保テスト
  1018                                          ;CALL    sysMalloc
  1019                                          ;MOV     CX, 0x0034
  1020                                          ;CALL    sysMalloc
  1021                                          ;PUSH    BP
  1022                                          ;MOV     CX, 0x0056
  1023                                          ;CALL    sysMalloc
  1024                                          ;POP     BP
  1025                                          ;CALL    sysFree
  1026                                          ;MOV     AX, 0x1010
  1027                                          ;MOV     BP, AX
  1028                                          ;CALL    sysFree
  1029                                          
  1030                                          ;PUSH    DS                      ; アロケーションテーブル
  1031                                          ;MOV     AX, 0x0000
  1032                                          ;MOV     DS, AX
  1033                                          ;MOV     AX, 0x0200
  1034                                          ;MOV     DI, 0x1000
  1035                                          ;CALL    dbgDump
  1036                                          ;POP     DS
  1037                                  %endif
  1038 00000919 E88000                          CALL    rPopReg                 ; レジスタ取得
  1039 0000091C C3                              RET
  1040                                  
  1041                                  ; mashのバージョン表示
  1042                                  ; ロゴとバージョンについて記載する
  1043                                  ; in  : なし
  1044                                  ; out : なし
  1045                                  cmdVer:
  1046 0000091D E85F00                          CALL    rPushReg                ; レジスタ退避
  1047 00000920 B80000                          MOV     AX, 0x0000
  1048 00000923 BD[0300]                        MOV     BP, cMashLogo           ; ロゴの表示
  1049 00000926 B90000                          MOV     CX, 0x0000
  1050                                  .loophead:
  1051 00000929 51                              PUSH    CX                      ; ループ変数格納
  1052 0000092A B413                            MOV     AH, 0x13
  1053 0000092C B001                            MOV     AL, 0x01
  1054 0000092E B700                            MOV     BH, 0
  1055 00000930 3E8A1E[EB00]                    MOV     BL, [DS:sColorNormal]
  1056 00000935 B92300                          MOV     CX, 35                  ; 1行35文字
  1057 00000938 3E8A36[EA00]                    MOV     DH, [DS:sYpos]
  1058 0000093D 3E8A16[E900]                    MOV     DL, [DS:sXpos]
  1059 00000942 CD10                            INT     0x10
  1060                                  
  1061 00000944 83C523                          ADD     BP, 35                  ; 1行35文字
  1062 00000947 59                              POP     CX                      ; ループ変数取得
  1063 00000948 C606[E900]00                    MOV BYTE [sXpos], 0x00
  1064 0000094D FE06[EA00]                      INC BYTE [sYpos]
  1065 00000951 41                              INC     CX
  1066 00000952 83F906                          CMP     CX, 0x0006
  1067 00000955 75D2                            JNZ     .loophead    
  1068                                  .next:
  1069 00000957 BD[D700]                        MOV     BP, cVersionStr
  1070 0000095A B413                            MOV     AH, 0x13                ; 版数の表示
  1071 0000095C B001                            MOV     AL, 0x01
  1072 0000095E B700                            MOV     BH, 0
  1073 00000960 8A1E[EB00]                      MOV     BL, [sColorNormal]
  1074 00000964 8B0E[D500]                      MOV     CX, [cVersionLen]
  1075 00000968 8A36[EA00]                      MOV     DH, [sYpos]
  1076 0000096C 8A16[E900]                      MOV     DL, [sXpos]
  1077 00000970 CD10                            INT     0x10
  1078 00000972 C606[E900]00                    MOV BYTE [sXpos], 0x00
  1079 00000977 FE06[EA00]                      INC BYTE [sYpos]
  1080 0000097B E81E00                          CALL    rPopReg                 ; レジスタ取得
  1081 0000097E C3                              RET
  1082                                          
  1083                                  ; 全レジスタの退避
  1084                                  ; 呼んだあと必ず rPopReg を呼ぶこと
  1085                                  ; 呼ぶ前 SP <- サブルーチンへのポインタ
  1086                                  ; 呼び後 SP <- BP <- DI <- SI <- DX <- CX <- BX <- AX
  1087                                  ; in  : reg     レジスタ
  1088                                  ; out : なし
  1089                                                                          ; tempAX    retAddr AX  stack
  1090                                  rPushReg:                               ; ??        ??      AX  ret
  1091 0000097F A3[9809]                        MOV     [.tempAX], AX           ; AX        ??      AX  ret
  1092 00000982 58                              POP     AX                      ; AX        ??      ret (空)
  1093 00000983 A3[9A09]                        MOV WORD    [.retAddr], AX      ; AX        ret     ret (空)
  1094 00000986 A1[9809]                        MOV     AX, [.tempAX]           ; AX        ret     AX  (空)
  1095                                  
  1096 00000989 50                              PUSH    AX                      ; AX        ret     AX  AX
  1097 0000098A 53                              PUSH    BX                      ; AX        ret     AX  BX)AX
  1098 0000098B 51                              PUSH    CX                      ; AX        ret     AX  CX)BX)AX
  1099 0000098C 52                              PUSH    DX                      ; AX        ret     AX  DX)CX)BX)AX
  1100 0000098D 56                              PUSH    SI                      ; AX        ret     AX  SI)DX)CX)BX)AX
  1101 0000098E 57                              PUSH    DI                      ; AX        ret     AX  DI)SI)DX)CX)BX)AX
  1102 0000098F 55                              PUSH    BP                      ; AX        ret     AX  BP)DI)SI)DX)CX)BX)AX
  1103                                  
  1104 00000990 A1[9A09]                        MOV WORD    AX, [.retAddr]      ; AX        ret     AX  BP)DI)SI)DX)CX)BX)AX
  1105 00000993 50                              PUSH    AX                      ; AX        ret     ret ret)BP)DI)SI)DX)CX)BX)AX
  1106 00000994 A1[9809]                        MOV     AX, [.tempAX]           ; AX        ret     AX  ret)BP)DI)SI)DX)CX)BX)AX
  1107 00000997 C3                              RET                             ; AX        ret     ret BP)DI)SI)DX)CX)BX)AX
  1108                                  .tempAX:                                ; AXレジスタを一時的に格納
  1109 00000998 0000                            DB      0x00, 0x00
  1110                                  .retAddr:                               ; ルーチンのリターンアドレス
  1111 0000099A 0000                            DB      0x00, 0x00
  1112                                  
  1113                                  ; レジスタの復帰
  1114                                  ; 呼ぶ前に必ず rPushReg を呼ぶこと
  1115                                  ; 呼ぶ前 SP <- サブルーチンへのポインタ <- BP <- DI <- SI <- DX <- CX <- BX <- AX
  1116                                  ; 呼び後 SP
  1117                                  ; in  : なし
  1118                                  ; out : reg     レジスタ
  1119                                                                          ; tempAX    retAddr AX  stack
  1120                                  rPopReg:                                ; ??        ??      AX  ret)BP)DI)SI)DX)CX)BX)AX
  1121 0000099C 58                              POP     AX                      ; ??        ??      ret BP)DI)SI)DX)CX)BX)AX
  1122 0000099D A3[B409]                        MOV WORD    [.retAddr], AX      ; ??        ret     ret BP)DI)SI)DX)CX)BX)AX
  1123                                  
  1124 000009A0 5D                              POP     BP                      ; ??        ret     ret DI)SI)DX)CX)BX)AX
  1125 000009A1 5F                              POP     DI                      ; ??        ret     ret SI)DX)CX)BX)AX
  1126 000009A2 5E                              POP     SI                      ; ??        ret     ret DX)CX)BX)AX
  1127 000009A3 5A                              POP     DX                      ; ??        ret     ret CX)BX)AX
  1128 000009A4 59                              POP     CX                      ; ??        ret     ret BX)AX
  1129 000009A5 5B                              POP     BX                      ; ??        ret     ret AX
  1130 000009A6 58                              POP     AX                      ; ??        ret     AX  (なし)
  1131                                  
  1132 000009A7 A3[B209]                        MOV     [.tempAX], AX           ; AX        ret     AX  (なし)
  1133 000009AA A1[B409]                        MOV WORD    AX, [.retAddr]      ; AX        ret     ret (なし)
  1134 000009AD 50                              PUSH    AX                      ; AX        ret     ret ret
  1135 000009AE A1[B209]                        MOV     AX, [.tempAX]           ; AX        ret     AX  ret
  1136 000009B1 C3                              RET                             ; AX        ret     AX
  1137                                  .tempAX:                                ; AXレジスタを一時的に格納
  1138 000009B2 0000                            DB      0x00, 0x00
  1139                                  .retAddr:                               ; ルーチンのリターンアドレス
  1140 000009B4 0000                            DB      0x00, 0x00
  1141                                  
  1142                                  ; ビープ音出力
  1143                                  ; in : なし
  1144                                  ; out: ビープ音
  1145                                  putBeep:
  1146 000009B6 B40E                            MOV     AH, 0x0e
  1147 000009B8 B041                            MOV     AL, 0x41
  1148 000009BA B700                            MOV     BH, 0x00
  1149 000009BC B301                            MOV     BL, 0x01
  1150 000009BE CD10                            INT     0x10
  1151 000009C0 C3                              RET
  1152                                  
  1153                                  ; シリアル1文字出力
  1154                                  ; in  : AL      ascii
  1155                                  ; out : (なし)
  1156                                  dbgSingle:
  1157 000009C1 E8BBFF                          CALL    rPushReg                ; レジスタ退避
  1158                                  
  1159 000009C4 B401                            MOV     AH, 0x01                ; 書き込み(ALreg)
  1160 000009C6 BA0000                          MOV     DX, 0x0000
  1161 000009C9 CD14                            INT     0x14
  1162                                  
  1163 000009CB E8CEFF                          CALL    rPopReg                 ; レジスタ取得
  1164 000009CE C3                              RET
  1165                                  
  1166                                  ; デバッグ用ダンプ
  1167                                  ; COM1を使って指定番地から指定バイトをダンプする
  1168                                  ; in  : AX      ダンプするバイト数
  1169                                  ;     : DS:DI   ダンプ開始アドレス
  1170                                  ; out : なし
  1171                                  dbgDump:
  1172 000009CF E8ADFF                          CALL    rPushReg                ; レジスタ退避
  1173                                  
  1174 000009D2 8CDB                            MOV     BX, DS
  1175 000009D4 891E[4D0A]                      MOV WORD [.focusSeg], BX
  1176 000009D8 893E[4F0A]                      MOV WORD [.focusAddr], DI
  1177 000009DC A3[510A]                        MOV WORD [.byteCnt], AX
  1178                                  
  1179 000009DF B400                            MOV     AH, 0x00                ; シリアルポート設定
  1180 000009E1 B0E3                            MOV     AL, 0xe3                ; 0bBBBPPSCC, 9600bps, None, 1bit, 8bit
  1181 000009E3 BA0000                          MOV     DX, 0x0000              ; 0ch = COM1, xch = COMx+1
  1182 000009E6 CD14                            INT     0x14
  1183                                  
  1184 000009E8 B00A                            MOV     AL, 0x0a                ; 改行文字
  1185 000009EA E85400                          CALL    .putchar
  1186                                  
  1187 000009ED B90000                          MOV     CX, 0x0000
  1188                                  .dumpLoop:
  1189 000009F0 51                              PUSH    CX
  1190 000009F1 8B1E[4D0A]                      MOV     BX, [.focusSeg]         ; asciiプリント
  1191 000009F5 8EDB                            MOV     DS, BX
  1192 000009F7 8B3E[4F0A]                      MOV     DI, [.focusAddr]
  1193 000009FB 3E8A05                          MOV     AL, [DS:DI]
  1194                                  
  1195 000009FE 50                              PUSH    AX
  1196 000009FF C0E804                          SHR     AL, 0x04                ; 上4bitプリント
  1197 00000A02 240F                            AND     AL, 0x0f
  1198 00000A04 3C0A                            CMP     AL, 0x0a
  1199 00000A06 7304                            JAE     .upperaf
  1200 00000A08 0430                            ADD     AL, 0x30                ; 0~9
  1201 00000A0A EB02                            JMP     .upperNext
  1202                                  .upperaf:
  1203 00000A0C 0437                            ADD     AL, 0x37                ; a~f
  1204                                  .upperNext:
  1205 00000A0E E83000                          CALL    .putchar
  1206                                  
  1207 00000A11 58                              POP     AX
  1208 00000A12 240F                            AND     AL, 0x0f                ; 下4bitプリント
  1209 00000A14 3C0A                            CMP     AL, 0x0a
  1210 00000A16 7304                            JAE     .loweraf
  1211 00000A18 0430                            ADD     AL, 0x30                ; 0~9
  1212 00000A1A EB02                            JMP     .lowerNext
  1213                                  .loweraf:
  1214 00000A1C 0437                            ADD     AL, 0x37                ; a~f
  1215                                  .lowerNext:
  1216 00000A1E E82000                          CALL    .putchar
  1217                                  
  1218 00000A21 B020                            MOV     AL, 0x20                ; 空白文字
  1219 00000A23 E81B00                          CALL    .putchar
  1220                                  
  1221 00000A26 47                              INC     DI
  1222 00000A27 893E[4F0A]                      MOV WORD [.focusAddr], DI
  1223 00000A2B 59                              POP     CX
  1224 00000A2C 41                              INC     CX
  1225 00000A2D 3B0E[510A]                      CMP WORD CX, [.byteCnt]
  1226 00000A31 75BD                            JNZ     .dumpLoop
  1227                                  
  1228 00000A33 B00D                            MOV     AL, 0x0d                ; \r
  1229 00000A35 E80900                          CALL    .putchar
  1230                                  
  1231 00000A38 B00A                            MOV     AL, 0x0a                ; \n
  1232 00000A3A E80400                          CALL    .putchar
  1233                                  
  1234 00000A3D E85CFF                          CALL    rPopReg                 ; レジスタ取得
  1235 00000A40 C3                              RET
  1236                                  .putchar:                               ; 1文字出力(ALreg)
  1237 00000A41 50                              PUSH    AX
  1238 00000A42 52                              PUSH    DX
  1239 00000A43 B401                            MOV     AH, 0x01                ; 書き込み
  1240 00000A45 BA0000                          MOV     DX, 0x0000
  1241 00000A48 CD14                            INT     0x14
  1242 00000A4A 5A                              POP     DX
  1243 00000A4B 58                              POP     AX
  1244 00000A4C C3                              RET
  1245                                  .focusSeg:                              ; ダンプするセグメント
  1246 00000A4D 0000                            DB      0x00, 0x00
  1247                                  .focusAddr:                             ; ダンプするアドレス
  1248 00000A4F 0000                            DB      0x00, 0x00
  1249                                  .byteCnt:                               ; ダンプするバイト数
  1250 00000A51 0000                            DB      0x00, 0x00
  1251                                  
  1252                                  ; レジスタダンプ
  1253                                  ; 内部で sysMalloc sysFree dbgDump を使用
  1254                                  ; in  : AX, BX, CX, DX, SI, DI, BP, SP, DS, ES, SS
  1255                                  dbgRegDump:
  1256 00000A53 E829FF                          CALL    rPushReg                ; レジスタ退避
  1257 00000A56 1E                              PUSH    DS
  1258                                  
  1259 00000A57 16                              PUSH    SS
  1260 00000A58 06                              PUSH    ES
  1261 00000A59 1E                              PUSH    DS
  1262 00000A5A 54                              PUSH    SP
  1263 00000A5B 55                              PUSH    BP
  1264 00000A5C 57                              PUSH    DI
  1265 00000A5D 56                              PUSH    SI
  1266 00000A5E 52                              PUSH    DX
  1267 00000A5F 51                              PUSH    CX
  1268 00000A60 53                              PUSH    BX
  1269 00000A61 50                              PUSH    AX
  1270                                  
  1271 00000A62 B91600                          MOV     CX, 22                  ; メモリ確保
  1272 00000A65 E8DDF9                          CALL    sysMalloc
  1273 00000A68 892E[9E0A]                      MOV WORD [.allocAddr], BP
  1274                                  
  1275 00000A6C B80000                          MOV     AX, 0x0000
  1276 00000A6F 8ED8                            MOV     DS, AX
  1277 00000A71 B90000                          MOV     CX, 0x0000
  1278                                  .popLoop:                               ; 2wordずつ格納
  1279 00000A74 58                              POP     AX
  1280 00000A75 30C4                            XOR     AH, AL                  ; リトルエンディアン → ビッグエンディアン
  1281 00000A77 30E0                            XOR     AL, AH
  1282 00000A79 30C4                            XOR     AH, AL
  1283 00000A7B 3E894600                        MOV WORD [DS:BP], AX
  1284 00000A7F 83C502                          ADD     BP, 0x0002
  1285 00000A82 41                              INC     CX
  1286 00000A83 83F90B                          CMP     CX, 11
  1287 00000A86 75EC                            JNZ     .popLoop
  1288                                  
  1289 00000A88 B81600                          MOV     AX, 22                  ; dbgDump で 表示
  1290 00000A8B 8B3E[9E0A]                      MOV     DI, [.allocAddr]
  1291 00000A8F E83DFF                          CALL    dbgDump
  1292                                  
  1293 00000A92 8B2E[9E0A]                      MOV WORD BP, [.allocAddr]       ; メモリ解放
  1294 00000A96 E848FA                          CALL    sysFree
  1295                                  
  1296 00000A99 1F                              POP     DS
  1297 00000A9A E8FFFE                          CALL    rPopReg                 ; レジスタ取得
  1298 00000A9D C3                              RET
  1299                                  .allocAddr:
  1300 00000A9E 0000                            DB      0x00, 0x00
  1301                                  
  1302                                  ; 16ビット値をシリアル出力
  1303                                  ; in  : AX      出力する値
  1304                                  dbgPrint16bit:
  1305                                          ; 確保したポインタを表示テスト
  1306 00000AA0 E8DCFE                          CALL    rPushReg
  1307                                          
  1308 00000AA3 BE[C90A]                        MOV     SI, .aDebugStr
  1309                                  
  1310 00000AA6 E88CFC                          CALL    libitox                 ; AXレジスタの値を4文字に変換
  1311                                  
  1312 00000AA9 B90000                          MOV     CX, 0x0000
  1313                                  .debugLoop:
  1314 00000AAC BE[C90A]                        MOV     SI, .aDebugStr
  1315 00000AAF 01CE                            ADD     SI, CX
  1316 00000AB1 8A04                            MOV BYTE AL, [SI]
  1317                                  
  1318 00000AB3 E80BFF                          CALL    dbgSingle               ; ALを出力
  1319                                  
  1320 00000AB6 83F903                          CMP     CX, 0x0003
  1321 00000AB9 7405                            JZ      .debugNext
  1322 00000ABB 83C101                          ADD     CX, 0x0001
  1323 00000ABE EBEC                            JMP     .debugLoop
  1324                                  
  1325                                  .debugNext:        
  1326 00000AC0 B00A                            MOV     AL, 0x0a                ; 改行
  1327 00000AC2 E8FCFE                          CALL    dbgSingle
  1328                                  
  1329 00000AC5 E8D4FE                          CALL    rPopReg
  1330 00000AC8 C3                              RET
  1331                                  
  1332                                  .aDebugStr:
  1333 00000AC9 00000000                        DB      0x00, 0x00, 0x00, 0x00
  1334                                  
  1335                                  mashHlt:
  1336 00000ACD EBFE                            JMP     mashHlt
  1337                                  
  1338                                  ; --- 0埋め ---
  1339                                  secEnd:
  1340 00000ACF 00<rep 3531h>                   times 0x4000-($-$$) DB 0        ; mash常駐は16セクタ
