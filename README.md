# mash仕様

masuda の shell だから mash 、よろしく。

## 目次
- [概要](#概要)
- [起動](#起動)
- [メモリ](#メモリ)
- [ディスク](#ディスク)
- [ファイル](#ファイル)
    - [ブートローダ(ipl.bin)](#ブートローダ(ipl.bin))
    - [セカンダリローダ(second.bin)](セカンダリローダ(second.bin))

## 概要

## 起動

## メモリ

## ディスク

システムディスクは2HDのフロッピーディスクからなり、ヘッダ2 * シリンダ18 * セクタ80 = 2880セクタを持つ。1セクタは512バイトのデータからなり、合計1.44MBのデータを記録する。

#### ファイルの配置

| LBA  | head | cyl  | sec  | file | 概要 |
| :--: | :--: | :--: | :--: | :--: | :--: |
|    0 |    0 |    0 |    1 | ipl.bin | ブートローダ |
|    1 |    0 |    0 |    2 | second.bin | セカンダリローダ |
|    2 |    0 |    0 |    3 | | |
|    3 |    0 |    0 |    4 | | |
|    4 |    0 |    0 |    5 | | |
|    5 |    0 |    0 |    6 | (ここから) | (ここから) |

## ファイル

### ブートローダ(ipl.bin)

- head 0, cyl 0, sec 1, len 1

BIOSがシステム起動時にメモリに展開する512バイト。

ブートローダは、以下の処理を行う。

1. レジスタ初期化
1. タイマを 0 に初期化
1. ビデオモードを 80列x25行(16色) に設定
1. 起動確認文字列を描画
1. セカンダリローダをディスクから 1000:8000 に展開
1. セカンダリローダに制御を移行

起動確認文字列は以下の通りである。
表示がされない場合ビデオモード設定までに問題が発生している。

```
Power on detection!!
```

セカンダリローダのディスク読み込みに失敗した場合、以下の文字列を表示する。

```
Disk read failed...
```

以後システムは無限ループに陥り、システムリセット以外の回復方法はない。

またディスク読み込みに成功した場合文字列表示は行わず、セカンダリローダに制御を移す。

---
### セカンダリローダ(second.bin)

- head 0, cyl 0, sec 2, len 4

ブートローダが読み込みファイル。システムのテスト、シェルへの制御受け渡しを実行する。

システムのテストは以下の手順にて実現する。

1. レジスタの初期化
1. 使用可能メモリのチェック
1. ディスクのチェック
1. ルートディレクトリへの移動
1. 環境変数の適用
1. シェルの展開
1. シェルへの制御受け渡し

セカンダリローダは以下のサブルーチンを持つ。

---
#### 16ビット値の数値 → 4桁の文字列変換(hex16ToAscii)

| input | output |
| :--: | :--: |
| DXreg: 16ビット値 | stack <- 4桁目 |
| | stack <- 3桁目 |
| | stack <- 2桁目 |
| | stack <- 1桁目 |

スタックには操作性のため16ビットのうち下位8ビットにasciiを格納する。

---
#### 4ビット値の数値 → 1桁の文字変換(hex04ToAscii)

| input | output |
| :--: | :--: |
| DXreg: 4ビット値 | CXreg: asciiコード |

---
#### 16ビットの数値を表示する(printHex)
| input | output |
| :--: | :--: |
| DXreg: 16ビット値 | (画面に表示) |

表示は6文字で 0x???? の形。