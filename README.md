# mash仕様

masuda の shell だから mash 、よろしく。

シェルとファイルシステムとカーネル作ります。

## 変更履歴
| 版数 | 日付 | 更新箇所 |
| ---: | :--: | :--- |
| 0.0.0 | 2025/09/21 | 初版 |
| 0.1.0 | 2025/09/23 | mash空ディスク作成 |
| 0.1.1 | 2025/09/23 | 起動時のロゴ+版数を適用 |

## 目次
- [概要](#概要)
- [起動](#起動)
- [メモリ](#メモリ)
- [ディスク](#ディスク)
    - [ディレクトリ](#ディレクトリ)
    - [ファイル先頭セクタ](#ファイル先頭セクタ)
    - [ファイルそれ以降のセクタ](#ファイルそれ以降のセクタ)
- [ファイル](#ファイル)
    - [ブートローダ(ipl.bin)](#ブートローダ(ipl.bin))
    - [セカンダリローダ(second.bin)](セカンダリローダ(second.bin))

## 概要

mashシステムはカーネル、ファイルシステム、コマンド実行からなり、以下の機能を提供する。

#### mash機能概要

| 機能 | 提供可否 |
| :--: | :--: |
| 対話式制御 | 〇 |
| スクリプト制御 | 〇 |
| ファイル操作 | 〇 |
| シェル変数 | 〇 |
| 環境変数 | 〇 |
| ブートローダ | 〇 |
| グラフィカル機能 | × |
| BIOS | × |
| ハードウェア | × |

本システムは以下の環境での動作を確約する。

#### mash動作要件

| 項目 | 最低要件 | 推奨要件 |
| :--: | :--: | :--: |
| プロセッサ | Intel 8086 | Intel Pentium75MHz 以降のx86 |
| メモリ | 192kB | 1MB(20bitフルアクセス) |
| ディスク | 2HDフロッピーディスクx1 | -- |
| 入力 | BIOSが識別できるキーボード | -- |
| 出力 | 80x25文字のディスプレイ  RS-232通信ポート | -- |
| BIOS | AT互換機のシステムBIOS | -- |
| 浮動小数点コプロセッサ | 不要 | -- |
| 外部ビデオカード | 不要 | -- |

## 入出力

コマンドの入出力は抽象化された

1. 標準入力(デフォルト: キーボード)
1. 標準出力(デフォルト: スクリーン)
1. 標準エラー出力(デフォルト: スクリーン)

を入出力として利用する。

コマンド実行時、これら3つの 入力/出力 先にハードウェアに固定されたデバイスを指定する。

#### ハードウェア番号
| No | 内容 | 入力 | 出力 |
| :--: | :--- | :--: | :--: |
| 0 | キーボード入力 | 〇 | × |
| 1 | スクリーン出力 | × | 〇 |
| 2 | シリアルポート | 〇 | 〇 |
| 3 | パイプ | 〇 | 〇 |
| 4~ | ファイル | 〇 | 〇 |

ファイルは fopen によりファイルディスクリプタを新規作成し、 fclose により削除する。

## メモリ

#### セグメント0
| addr | 内容 |
| :--: | :--- |
| 0x0000 ~ 0x03ff | INT割り込みベクタ |
| 0x0400 ~ 0x04ff | BIOSワークエリア |
| 0x0500 ~ 0x0fff | (空き) |
| 0x1000 ~ 0x1fff | メモリアロケーションテーブル |
| 0x???? ~ 0x???? | ディスクアロケーションテーブル |
| 0x???? ~ 0x3fff | スタック領域 |
| 0x4000 ~ 0x7fff | シェル常駐部分 |
| 0x8000 ~  

#### セグメント1
| addr | 内容 |
| :--: | :--- |
| 0x0000 ~ 0xffff | アロケーションメモリ |

## ディスク

システムディスクは2HDのフロッピーディスクからなり、ヘッダ2 * シリンダ18 * セクタ80 = 2880セクタを持つ。1セクタは512バイトのデータからなり、合計1.44MBのデータを記録する。

#### ファイルの配置

| LBA  |  cyl | head | sec  | file | 概要 |
| :--: | :--: | :--: | :--: | :--: | :--: |
|    0 |    0 |    0 |    1 | ipl.bin | ブートローダ |
|    1 |    0 |    0 |    2 | second.bin | セカンダリローダ |
|  ... |  ... |  ... |  ... | | |
|    4 |    0 |    0 |    5 | | |
|    5 |    0 |    0 |    6 | mash.bin | シェル本体 |
|  ... |  ... |  ... |  ... | | |
|   20 |    0 |    1 |    3 | | |
|   21 |    0 |    1 |    4 | root.bin | ルートディレクトリ |
|   22 |    0 |    1 |    5 | (ライブラリ) |  | 

ファイルの情報は
1. ディレクトリ
    1. 先頭セクタ
1. ファイル
    1. 先頭セクタ
    1. それ以降のセクタ

からなり、各セクタは以下の情報を持つ

### ディレクトリ

ディレクトリは単一のセクタからなり、以下の情報を持つ。

#### ディレクトリのデータ仕様

| offset | 項目 | 概要 |
| :--: | :--: | :--: |
| 0 | アトリビュート | セクタ属性(0:未使用 1:ディレクトリ 2:ファイル)
| 1 ~ 8 | ファイル名 | 最大8文字のファイル名、登録制限あり |
| 9 ~ 11 | 拡張子 | 最大3文字(ディレクトリの場合制御に関与しない) |
| 12 ~ 17 | 作成時刻 | 年、月、日、時、分、秒 |
| 18 ~ 23 | 更新時刻 | 年、月、日、時、分、秒 |
| 24 | 子ファイルの数 | ディレクトリが持つファイルの数 |
| 25 | 親ディレクトリ | 親のディレクトリのLBA、ルートディレクトリの場合 0x0000 |
| 26 ~ 255 | 子ファイルの列挙 | ディレクトリが持つ子のLBA列挙 |

セクタは、それぞれ以下の役割を果たす。

### ファイル先頭セクタ

#### ファイル先頭セクタのデータ仕様

| offset | 項目 | 概要 |
| :--: | :--: | :--: |
| 0 | アトリビュート | セクタ属性(0:未使用 1:ディレクトリ 2:ファイル)
| 1 ~ 8 | ファイル名 | 最大8文字のファイル名、登録制限あり |
| 9 ~ 11 | 拡張子 | 最大3文字、アルファベットのみ |
| 12 ~ 17 | 作成時刻 | 年、月、日、時、分、秒 |
| 18 ~ 23 | 更新時刻 | 年、月、日、時、分、秒 |
| 24 | ファイルサイズ | 「それ以降のセクタ」の数につながる |
| 25 ~ 255 | ファイルチェーン | 「それ以外のセクタ」のLBA列挙 |

### ファイルそれ以降のセクタ

ファイルの先頭に列挙されるセクタには、列挙順にデータが格納される。

512バイトすべて有効な実行形式やテキストを格納できる。

末尾のセクタのデータはファイル先頭セクタのファイルサイズを参考に有効な場所まで読みこまれる。

#### ディレクトリ構造

## ファイル

### ファイル構造

以下にファイルのディレクトリ構造について記載する。

ファイル間のアクセスについては上記 ディレクトリのデータ仕様 を参照すること。

```
/
 ├bin
 │ ├sh
 │ │ ├mash.bin
 │ │ └save.bin
 │ │
 │ └lib
 │   ├sample.bin
 │   └(追記予定)
 │
 ├usr
 │ └(追記予定)
```

### ブートローダ(ipl.bin)

- head 0, cyl 0, sec 1, len 1

BIOSがシステム起動時にメモリに展開する512バイト。

ブートローダは、以下の処理を行う。

1. レジスタ初期化
1. タイマを 0 に初期化
1. ビデオモードを 80列x25行(16色) に設定
1. 起動確認文字列を描画
1. セカンダリローダをディスクから 1000:8000 に展開
1. セカンダリローダに制御を移行

起動確認文字列は以下の通りである。
表示がされない場合ビデオモード設定までに問題が発生している。

```
Power on detection!!
```

セカンダリローダのディスク読み込みに失敗した場合、以下の文字列を表示する。

```
Disk read failed...
```

以後システムは無限ループに陥り、システムリセット以外の回復方法はない。

またディスク読み込みに成功した場合文字列表示は行わず、セカンダリローダに制御を移す。

---
### セカンダリローダ(second.bin)

- head 0, cyl 0, sec 2, len 4

ブートローダが読み込みファイル。システムのテスト、シェルへの制御受け渡しを実行する。

システムのテストは以下の手順にて実現する。

1. レジスタの初期化
1. メモリのチェック
1. ディスクのチェック
1. ルートディレクトリへの移動
1. 環境変数の適用
1. シェルの展開
1. シェルへの制御受け渡し

セカンダリローダは以下のサブルーチンを持つ。

#### レジスタの初期化

レジスタの初期化は、セグメントレジスタ(DS, ES, SS)を CS に統一し、スタックポインタを 0xffff に設定する。

#### メモリのチェック

メモリのチェックは、シェルを展開するメモリ 0x0000 ~ 0x7ffff をチェックする。

チェックは以下の処理を行う。

1. メモリ1バイトに 0x55 を書き込む
1. 0x55 が取得できるか確認する
1. メモリ1バイトに 0xaa を書き込む
1. 0xaa が取得できるか確認する
1. 次の1バイトに移動する

表示が止まった場合、表示されたメモリ + 1 番地に異常がある。

#### ディスクのチェック

ディスクのチェックは、シェルとライブラリが存在するセクタ(一旦64セクタ)の読み込みが正常に行えるか確認する。

チェックは以下の処理を行う。

1. LBAをCHSに変換する
1. CHSの指すディスクを読む
1. BIOSの戻り値が正常か確認する
1. 次のセクタに移動する

表示が止まった場合、表示されたLBA + 1 番目のセクタに異常がある。

LBAからCHS(cylinder, head, sector)は以下の変換より取得する。

```
H = (LBA / 18) % 2
C = LBA / (18 * 2)
S = (LBA % 18) + 1
```

---
#### 16ビット値の数値 → 4桁の文字列変換(hex16ToAscii)

| input | output |
| :--: | :--: |
| DXreg: 16ビット値 | stack <- 4桁目 |
| | stack <- 3桁目 |
| | stack <- 2桁目 |
| | stack <- 1桁目 |

スタックには操作性のため16ビットのうち下位8ビットにasciiを格納する。

---
#### 4ビット値の数値 → 1桁の文字変換(hex04ToAscii)

| input | output |
| :--: | :--: |
| DXreg: 4ビット値 | CXreg: asciiコード |

---
#### 16ビットの数値を表示する(printHex)
| input | output |
| :--: | :--: |
| DXreg: 16ビット値 | (画面に表示) |

表示は6文字で 0x???? の形。