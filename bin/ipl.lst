     1                                  ; second
     2                                  ; TAB=4
     3                                  
     4 00000000 EB02                            JMP     secMain
     5                                  
     6                                  ; --- 変数 ---
     7                                  secCursolX:
     8 00000002 10                              DB      0x10            ; 表示xカーソル
     9                                  
    10                                  secCursolY:
    11 00000003 10                              DB      0x10            ; 表示yカーソル
    12                                  
    13                                  ; --- セカンダリローダ ---
    14                                  secMain:
    15 00000004 E80300                          CALL    secTest
    16 00000007 E80700                          CALL    secHlt
    17                                  
    18                                  ; --- テスト ---
    19                                  secTest:
    20 0000000A BAAB89                          MOV     DX, 0x89ab
    21 0000000D E86500                          CALL    printHex
    22 00000010 C3                              RET
    23                                  
    24                                  secHlt:
    25 00000011 EBFE                            JMP     secHlt
    26                                  
    27                                  ; --- サブルーチン ---
    28                                  
    29                                  ; 16ビット数値 → 4文字の文字列変換
    30                                  ; in : DXreg    変換する値
    31                                  ; out: (SP  )   1文字目の文字コード(下位8bit)
    32                                  ; out: (SP+2)   2文字目の文字コード
    33                                  ; out: (SP+4)   3文字目の文字コード
    34                                  ; out: (SP+6)   4文字目の文字コード
    35                                  hex16ToAscii:
    36 00000013 5B                              POP     BX              ; 戻るポインタ
    37                                  
    38 00000014 52                              PUSH    DX              ; 1桁目
    39 00000015 89D1                            MOV     CX, DX          
    40 00000017 83E10F                          AND     CX, 0x000f
    41 0000001A C1E900                          SHR     CX, 0
    42 0000001D 89CA                            MOV     DX, CX
    43 0000001F E83700                          CALL    hex04ToAscii
    44 00000022 5A                              POP     DX
    45 00000023 51                              PUSH    CX              ; スタックに格納
    46                                  
    47 00000024 52                              PUSH    DX              ; 2桁目
    48 00000025 89D1                            MOV     CX, DX          
    49 00000027 81E1F000                        AND     CX, 0x00f0
    50 0000002B C1E904                          SHR     CX, 4
    51 0000002E 89CA                            MOV     DX, CX
    52 00000030 E82600                          CALL    hex04ToAscii
    53 00000033 5A                              POP     DX
    54 00000034 51                              PUSH    CX              ; スタックに格納
    55                                  
    56 00000035 52                              PUSH    DX              ; 3桁目
    57 00000036 89D1                            MOV     CX, DX          
    58 00000038 81E1000F                        AND     CX, 0x0f00
    59 0000003C C1E908                          SHR     CX, 8
    60 0000003F 89CA                            MOV     DX, CX
    61 00000041 E81500                          CALL    hex04ToAscii
    62 00000044 5A                              POP     DX
    63 00000045 51                              PUSH    CX              ; スタックに格納
    64                                  
    65 00000046 52                              PUSH    DX              ; 4桁目
    66 00000047 89D1                            MOV     CX, DX          
    67 00000049 81E100F0                        AND     CX, 0xf000      ; 15~12bit
    68 0000004D C1E90C                          SHR     CX, 12          ; 12→0
    69 00000050 89CA                            MOV     DX, CX
    70 00000052 E80400                          CALL    hex04ToAscii    ; 1桁変換
    71 00000055 5A                              POP     DX
    72 00000056 51                              PUSH    CX              ; スタックに格納
    73                                                                  ; SP <- 1桁目 <- 2 <- 3 <- 4
    74 00000057 53                              PUSH    BX              ; 戻るポインタを格納
    75 00000058 C3                              RET
    76                                  
    77                                  ; 4ビット数値 → 1文字の文字列変換
    78                                  ; in : DXreg    変換する値(下位4bit)
    79                                  ; out: CXreg    変換する値(下位4bit)
    80                                  hex04ToAscii:
    81 00000059 52                              PUSH    DX
    82 0000005A 83E20F                          AND     DX, 0x000f      ; 4ビットに限定
    83 0000005D 83FA0A                          CMP     DX, 0x000a
    84 00000060 7307                            JAE     .upper          ; 10以上ならジャンプ
    85                                  .lower:                         ; '0'~'9'
    86 00000062 B93000                          MOV     CX, "0"
    87 00000065 01D1                            ADD     CX, DX
    88 00000067 EB0A                            JMP     .exit
    89                                  .upper:                         ; 'A'~'F'
    90 00000069 B94100                          MOV     CX, "A"
    91 0000006C 01D1                            ADD     CX, DX
    92 0000006E 83E90A                          SUB     CX, 0x0a
    93 00000071 EB00                            JMP     .exit
    94                                  .exit:
    95 00000073 5A                              POP     DX
    96 00000074 C3                              RET
    97                                  
    98                                  ; 16ビットの数値を表示する
    99                                  ; in : DXreg    表示する値
   100                                  ; out: なし
   101                                  printHex:
   102 00000075 E89BFF                          CALL    hex16ToAscii    ; 変換
   103 00000078 BB0000                          MOV     BX, 0x0000      ; ループ初期化
   104                                  
   105                                  .popLoop:                       ; 4回繰り返し
   106 0000007B 59                              POP     CX
   107 0000007C BF[A800]                        MOV     DI, .msg
   108 0000007F 01DF                            ADD     DI, BX          ; アドレス
   109 00000081 880D                            MOV     [DI], CL
   110 00000083 83C301                          ADD     BX, 0x0001
   111 00000086 83FB04                          CMP     BX, 0x04
   112 00000089 7402                            JZ      .next
   113 0000008B EBEE                            JMP     .popLoop
   114                                  .next:  
   115 0000008D 8A16[0200]                      MOV     DL, [secCursolX]
   116 00000091 8A36[0300]                      MOV     DH, [secCursolY]
   117 00000095 B413                            MOV	AH, 0x13
   118 00000097 B001                            MOV	AL, 0x01
   119 00000099 B700                            MOV	BH, 0x00
   120 0000009B B30F                            MOV	BL, 0x0f
   121 0000009D B90400                          MOV	CX, 0x0004
   122 000000A0 0E                              PUSH	CS
   123 000000A1 07                              POP	ES
   124 000000A2 BD[A800]                        MOV	BP, .msg
   125 000000A5 CD10                            INT	0x10
   126 000000A7 C3                              RET
   127                                  
   128                                  .msg:                           ; 表示する4バイト
   129 000000A8 30303030                        DB      0x30, 0x30, 0x30, 0x30
   130                                  
   131                                  ; --- 0埋め ---
   132                                  secEnd:
   133 000000AC 00<rep 754h>                    times 2048-($-$$) DB 0  ; セカンダリローダは4セクタ
