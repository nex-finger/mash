# mash仕様

## 目次

## 概要

## 起動

## メモリ

## ディスク

システムディスクは2HDのフロッピーディスクからなり、ヘッダ2 * シリンダ18 * セクタ80 = 2880セクタを持つ。1セクタは512バイトのデータからなり、合計1.44MBのデータを記録する。

#### ファイルの配置

| LBA  | head | cyl  | sec  | file | 概要 |
| :--: | :--: | :--: | :--: | :--: | :--: |
|    0 |    0 |    0 |    1 | ipl.bin | ブートローダ |
|    1 |    0 |    0 |    2 | second.bin | セカンダリローダ |
|    2 |    0 |    0 |    3 | | |
|    3 |    0 |    0 |    4 | | |
|    4 |    0 |    0 |    5 | | |
|    5 |    0 |    0 |    6 | (ここから) | (ここから) |

## ファイル

### ブートローダ(ipl.bin)

- head 0, cyl 0, sec 1, len 1

BIOSがシステム起動時にメモリに展開する512バイト。

レジスタの初期化、タイマの初期化、ビデオモードを80x25に初期化、"Power on detection!!\r\n"の表示、セカンダリローダの読み込みを行う。

セカンダリローダの読み込みに成功した場合、制御をセカンダリローダに移し、読み込みに失敗した場合、"Disk read failed...\r\n"の表示後動作を停止する。

### セカンダリローダ(second.bin)

- head 0, cyl 0, sec 2, len 4

ブートローダが読み込みファイル。システムのテスト、シェルへの制御受け渡しを実行する。

システムのテストは以下の手順にて実現する。

1. 使用可能メモリのチェック
1. ディスクのチェック
1. ルートディレクトリへの移動
1. 環境変数の適用
1. シェルの展開
1. シェルへの制御受け渡し

セカンダリローダは以下のサブルーチンを持つ。

---
#### 16ビット値の数値 → 4桁の文字列変換(hex16ToAscii)

| input | output |
| :--: | :--: |
| DXreg: 16ビット値 | stack <- 4桁目 |
| | stack <- 3桁目 |
| | stack <- 2桁目 |
| | stack <- 1桁目 |

スタックには操作性のため16ビットのうち下位8ビットにasciiを格納する

---
#### 4ビット値の数値 → 1桁の文字変換(hex04ToAscii)

| input | output |
| :--: | :--: |
| DXreg: 4ビット値 | CXreg: asciiコード |

---
#### 16ビットの数値を表示する(printHex)
| input | output |
| :--: | :--: |
| DXreg: 16ビット値 | (画面に表示) |